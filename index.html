<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heimspielabrechnung The Deers</title>
  <link rel="icon" type="image/svg" href="The Deers Logo nur Hirsch.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase v10 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyD5B4C8EiEdLA2XWLzb2JvcFi9DAnV1M7E",
      authDomain: "thedeersabrechnung.firebaseapp.com",
      projectId: "thedeersabrechnung",
      storageBucket: "thedeersabrechnung.firebasestorage.app",
      messagingSenderId: "27261468983",
      appId: "1:27261468983:web:1a6340756263aad9455ab2",
      measurementId: "G-6KBNXWTYJ1"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Firebase Funktionen global verf√ºgbar machen
    window.firebaseDB = db;
    window.firebaseUtils = { collection, addDoc, getDocs, updateDoc, doc, deleteDoc };
  </script>
  <style>
    .modal-game-background {
      background-image: url('The Deers Logo dunkelgrau-hellgrau.svg');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
      background-attachment: fixed;
      position: relative;
    }
    
    .modal-game-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      z-index: 1;
    }
    
    .modal-game-content {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

  <!-- √úberschrift -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Heimspielabrechnung The Deers</h1>
    <p class="text-xl text-gray-600">TSV Hirschaid</p>
  </div>

  <!-- Button: Neues Heimspiel -->
  <button id="btnNewGame" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">Neues Heimspiel</button>

  <!-- Container f√ºr gespeicherte Formulare -->
  <div id="gamesContainer"></div>

  <!-- Modal: Spiel -->
  <div id="modalGame" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-game-background">
     <div class="modal-game-content"> 
	  <h2 class="text-xl font-bold mb-4">Spiel</h2>

      <div class="flex space-x-4 mb-4">
        <!-- Dropdown Team -->
        <div>
          <label class="block text-sm font-medium mb-1">Team</label>
          <select id="selectTeam" class="border rounded w-40 p-2">
            <option value="">Bitte w√§hlen</option>
            <option value="TheDeers I">TheDeers I</option>
            <option value="TheDeers II">TheDeers II</option>
            <option value="TheDeers III">TheDeers III</option>
            <option value="TheDeers IV">TheDeers IV</option>
          </select>
        </div>

        <!-- Gegner -->
        <div>
          <label class="block text-sm font-medium mb-1">Gegner</label>
          <input type="text" id="inputOpponent" class="border rounded w-40 p-2" />
        </div>

        <!-- Datum -->
        <div>
          <label class="block text-sm font-medium mb-1">Datum</label>
          <input type="date" id="inputDate" class="border rounded w-40 p-2" />
        </div>
      </div>

      <!-- Tabelle G√§ste -->
      <table class="w-full text-sm mb-4" id="tab_Gaeste">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Getr√§nke</th>
            <th class="p-2 border">Essen</th>
            <th class="p-2 border">Gesamtbetrag</th>
            <th class="p-2 border">Abrechnung</th>
            <th class="p-2 border">Aktion</th>
          </tr>
        </thead>
        <tbody>
          <!-- Zeilen werden dynamisch hinzugef√ºgt -->
        </tbody>
      </table>
      <button id="addGuestRow" class="text-blue-600 mb-4 hover:text-blue-800">+ Gast hinzuf√ºgen</button>

      <!-- Spiel abrechnen, Speichern & Schlie√üen -->
      <div class="flex justify-end space-x-2">
        <button id="btnFinalizeGame" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded" disabled>Spiel abrechnen</button>
        <button id="btnSaveGame" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGame" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>

    </div>
  </div>

  <!-- Modal: Getr√§nke -->
  <div id="modalGetraenke" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Getr√§nke</h2>
      <table class="w-full text-sm mb-4" id="tab_Getraenke">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Preis</th>
            <th class="p-2 border">Anzahl</th>
            <th class="p-2 border">Zwischensumme</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamisch bef√ºllt -->
        </tbody>
      </table>
      <div class="mb-4 font-semibold">Summe Getr√§nke: <span id="summe_Getraenke">0.00</span> ‚Ç¨</div>
      <div class="flex justify-end space-x-2">
        <button id="btnSaveGetraenke" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGetraenke" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Essen -->
  <div id="modalEssen" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Essen ausw√§hlen</h2>
      <table class="min-w-full border mb-4">
        <thead>
          <tr>
            <th class="border p-2">Name</th>
            <th class="border p-2">Preis (‚Ç¨)</th>
            <th class="border p-2">Anzahl</th>
            <th class="border p-2">Zwischensumme (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody id="tab_Essen">
          <!-- Dynamisch per JS bef√ºllt -->
        </tbody>
      </table>
      <div class="mb-4 font-semibold">
        <strong>Gesamtsumme Essen:</strong> <span id="summe_Essen">0.00</span> ‚Ç¨
      </div>
      <button id="btnSaveEssen" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Speichern</button>
      <button id="btnCloseEssen" class="bg-gray-500 text-white px-4 py-2 rounded ml-2 hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>

  <!-- Modal: Abrechnung -->
  <div id="modalAbrechnung" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Abrechnung</h2>
      <div id="abrechnungContent"></div>
      <div class="my-4">
        <label class="block text-sm font-medium mb-1">Trinkgeld (‚Ç¨)</label>
        <input type="number" id="inputTip" class="border rounded w-full p-2" step="0.01" min="0" />
      </div>
      <div class="flex justify-end space-x-2">
        <button id="btnPaid" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Bezahlt</button>
        <button id="btnCloseAbrechnung" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>
    </div>
  </div>

<script>

let gespeicherteSpiele = [];
let editIndex = null;
let aktuelleGetraenkeRow = null;
let aktuelleEssenRow = null;
let aktuelleAbrechnungRow = null;

// Getr√§nke und Essen Daten
const getraenkeListe = [
  { name: 'Softdrink/Wasser', preis: 2.50 },
  { name: 'Bier des Monats', preis: 3.50 },
  { name: 'Krausenbier', preis: 3.00 },
  { name: 'Weizen', preis: 3.50 },
  { name: 'Winzerschorle', preis: 4.50 },
  { name: 'Kaffee/Tee', preis: 1.50 },
  { name: 'Cola', preis: 2.50 }
];

const essenListe = [
  { name: 'Pizza', preis: 9.00 },
  { name: 'Chicken Nuggets', preis: 5.00 },
  { name: 'Chilli Cheese Nuggets', preis: 5.00 },
  { name: 'Riegel', preis: 1.00 }
];

// Hilfsfunktion zum Runden auf 2 Nachkommastellen
function round2(num) {
  return Math.round(num * 100) / 100;
}

// Hilfsfunktion f√ºr Datumsformatierung
function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split("-");
  return `${day}.${month}.${year}`;
}

// Firebase Funktionen
async function saveGameToFirebase(spielData) {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return null;
    }
    
    const docRef = await window.firebaseUtils.addDoc(
      window.firebaseUtils.collection(window.firebaseDB, "spiele"), 
      {
        ...spielData,
        timestamp: new Date().toISOString()
      }
    );
    console.log("Spiel in Firebase gespeichert mit ID: ", docRef.id);
    return docRef.id;
  } catch (error) {
    console.error("Fehler beim Speichern in Firebase: ", error);
    return null;
  }
}

async function updateGameInFirebase(gameId, spielData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      ...spielData,
      lastUpdated: new Date().toISOString()
    });
    console.log("Spiel in Firebase aktualisiert:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Aktualisieren in Firebase: ", error);
    return false;
  }
}

async function deleteGameFromFirebase(gameId) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.deleteDoc(gameRef);
    console.log("Spiel aus Firebase gel√∂scht:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim L√∂schen aus Firebase: ", error);
    return false;
  }
}

async function loadGamesFromFirebase() {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return;
    }
    
    const querySnapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );
    
    gespeicherteSpiele = [];
    querySnapshot.forEach((doc) => {
      gespeicherteSpiele.push({
        id: doc.id,
        firebaseId: doc.id,
        ...doc.data()
      });
    });
    
    renderGames();
  } catch (error) {
    console.error("Fehler beim Laden aus Firebase: ", error);
  }
}

// PDF in Firebase speichern
async function savePDFToFirebase(gameId, pdfData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      pdfData: pdfData,
      pdfCreatedAt: new Date().toISOString()
    });
    console.log("PDF in Firebase gespeichert f√ºr Spiel:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Speichern des PDFs in Firebase: ", error);
    return false;
  }
}

// Event Listeners
document.getElementById('btnNewGame').addEventListener('click', () => {
  editIndex = null;
  clearGameForm();
  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
  document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  initializeGaesteTable();
});

document.getElementById('btnCloseGame').addEventListener('click', () => {
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
});

document.getElementById('btnCloseGetraenke').addEventListener('click', () => {
  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

document.getElementById('btnCloseEssen').addEventListener('click', () => {
  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

document.getElementById('btnCloseAbrechnung').addEventListener('click', () => {
  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
});

document.getElementById('addGuestRow').addEventListener('click', addGuestRow);

// Form zur√ºcksetzen
function clearGameForm() {
  document.getElementById('selectTeam').value = '';
  document.getElementById('inputOpponent').value = '';
  document.getElementById('inputDate').value = '';
  document.querySelector('#tab_Gaeste tbody').innerHTML = '';
}

function initializeGaesteTable() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  for (let i = 0; i < 4; i++) addGuestRow();
}

function addGuestRow() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td class="border p-2">
      <input type="text" class="border rounded w-full p-1" placeholder="Name" />
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddGetraenke hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddEssen hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2 summeGesamt text-right">0.00 ‚Ç¨</td>
    <td class="border p-2">
      <button class="bg-gray-500 text-white px-2 py-1 rounded btnAbrechnen hover:bg-gray-600">Abrechnen</button>
    </td>
    <td class="border p-2 text-center">
      <button class="bg-red-600 text-white px-2 py-1 rounded btnDeleteGuest hover:bg-red-700">X</button>
    </td>
  `;
  tbody.appendChild(row);

  // Event-Listener f√ºr Buttons in der neuen Zeile
  row.querySelector('.btnAddGetraenke').addEventListener('click', () => openGetraenkeModal(row));
  row.querySelector('.btnAddEssen').addEventListener('click', () => openEssenModal(row));
  row.querySelector('.btnAbrechnen').addEventListener('click', () => openAbrechnungModal(row));
  row.querySelector('.btnDeleteGuest').addEventListener('click', () => {
    row.remove();
    updateFinalizeButtonState();
  });
}

// Getr√§nke Modal √∂ffnen
function openGetraenkeModal(row) {
  aktuelleGetraenkeRow = row;
  const tbody = document.querySelector('#tab_Getraenke tbody');
  tbody.innerHTML = '';

  // Lade bereits vorhandene Getr√§nke aus Daten-Attribut
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  let getraenkeData = gespeicherteGetraenke ? JSON.parse(gespeicherteGetraenke) : {};

  getraenkeListe.forEach((getraenk) => {
    const menge = getraenkeData[getraenk.name] || 0;
    const zwischensumme = round2(getraenk.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 border">${getraenk.name}</td>
      <td class="p-2 border text-right">${getraenk.preis.toFixed(2)} ‚Ç¨</td>
      <td class="p-2 border text-center">
        <input type="number" min="0" value="${menge}" class="inputAnzahl border rounded w-16 text-center p-1" data-preis="${getraenk.preis}" />
      </td>
      <td class="p-2 border zwischensumme text-right">${zwischensumme} ‚Ç¨</td>
    `;
    tbody.appendChild(tr);

    // Event f√ºr Eingabe √Ñnderung
    tr.querySelector('.inputAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum + ' ‚Ç¨';
      updateGetraenkeSumme();
    });
  });

  updateGetraenkeSumme();
  document.getElementById('modalGetraenke').classList.remove('hidden');
}

function updateGetraenkeSumme() {
  const tbody = document.querySelector('#tab_Getraenke tbody');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent.replace(' ‚Ç¨', '');
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Getraenke').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveGetraenke').addEventListener('click', () => {
  if (!aktuelleGetraenkeRow) return;

  const tbody = document.querySelector('#tab_Getraenke tbody');
  const getraenkeData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputAnzahl').value) || 0;
    if (menge > 0) {
      getraenkeData[name] = menge;
    }
  });

  aktuelleGetraenkeRow.setAttribute('data-getraenke', JSON.stringify(getraenkeData));
  updateGesamtbetrag(aktuelleGetraenkeRow);

  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

// Essen Modal √∂ffnen
function openEssenModal(row) {
  aktuelleEssenRow = row;
  const tbody = document.getElementById('tab_Essen');
  tbody.innerHTML = '';

  // Lade gespeicherte Essen-Daten
  let gespeicherteEssen = row.getAttribute('data-essen');
  let essenData = gespeicherteEssen ? JSON.parse(gespeicherteEssen) : {};

  essenListe.forEach(item => {
    const menge = essenData[item.name] || 0;
    const zwischensumme = round2(item.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-2 py-1">${item.name}</td>
      <td class="border px-2 py-1 text-right">${item.preis.toFixed(2)}</td>
      <td class="border px-2 py-1 text-center">
        <input type="number" min="0" value="${menge}" class="inputEssenAnzahl border rounded w-16 text-center p-1" data-preis="${item.preis}" />
      </td>
      <td class="border px-2 py-1 text-right zwischensumme">${zwischensumme}</td>
    `;
    tbody.appendChild(tr);

    tr.querySelector('.inputEssenAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum;
      updateEssenSumme();
    });
  });

  updateEssenSumme();
  document.getElementById('modalEssen').classList.remove('hidden');
}

function updateEssenSumme() {
  const tbody = document.getElementById('tab_Essen');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent;
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Essen').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveEssen').addEventListener('click', () => {
  if (!aktuelleEssenRow) return;

  const tbody = document.getElementById('tab_Essen');
  const essenData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputEssenAnzahl').value) || 0;
    if (menge > 0) {
      essenData[name] = menge;
    }
  });

  aktuelleEssenRow.setAttribute('data-essen', JSON.stringify(essenData));
  updateGesamtbetrag(aktuelleEssenRow);

  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

// Berechnung und Aktualisierung des Gesamtbetrags je Gast
function updateGesamtbetrag(row) {
  let sumGetraenke = 0;
  let sumEssen = 0;

  // Getr√§nke summieren
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    for (const name in getraenkeData) {
      const menge = getraenkeData[name];
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        sumGetraenke += getraenk.preis * menge;
      }
    }
  }

  // Essen summieren
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    for (const name in essenData) {
      const menge = essenData[name];
      const essen = essenListe.find(e => e.name === name);
      if (essen) {
        sumEssen += essen.preis * menge;
      }
    }
  }

  const summeGesamt = round2(sumGetraenke + sumEssen);
  row.querySelector('.summeGesamt').textContent = summeGesamt.toFixed(2) + ' ‚Ç¨';
}

// Abrechnung Modal √∂ffnen
function openAbrechnungModal(row) {
  aktuelleAbrechnungRow = row;
  const abrechnung = document.getElementById('abrechnungContent');
  const name = row.querySelector('input[type="text"]').value || '(unbekannt)';
  const summeText = row.querySelector('.summeGesamt').textContent || '0.00 ‚Ç¨';

  // Getr√§nke laden
  let getraenkeHtml = '<h3 class="font-semibold mt-2">Getr√§nke:</h3>';
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    if (Object.keys(getraenkeData).length === 0) {
      getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
    } else {
      getraenkeHtml += '<ul class="list-disc ml-5">';
      for (const nameGetr in getraenkeData) {
        const menge = getraenkeData[nameGetr];
        const getraenk = getraenkeListe.find(g => g.name === nameGetr);
        const preis = getraenk ? getraenk.preis : 0;
        getraenkeHtml += `<li>${nameGetr}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      getraenkeHtml += '</ul>';
    }
  } else {
    getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
  }

  // Essen laden
  let essenHtml = '<h3 class="font-semibold mt-2">Essen:</h3>';
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    if (Object.keys(essenData).length === 0) {
      essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
    } else {
      essenHtml += '<ul class="list-disc ml-5">';
      for (const nameEssen in essenData) {
        const menge = essenData[nameEssen];
        const essen = essenListe.find(e => e.name === nameEssen);
        const preis = essen ? essen.preis : 0;
        essenHtml += `<li>${nameEssen}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      essenHtml += '</ul>';
    }
  } else {
    essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
  }

  abrechnung.innerHTML = `
    <div class="bg-gray-50 p-3 rounded">
      <p><strong>Gast:</strong> ${name}</p>
      <p><strong>Gesamtbetrag:</strong> ${summeText}</p>
      ${getraenkeHtml}
      ${essenHtml}
    </div>
  `;

  document.getElementById('inputTip').value = '';
  document.getElementById('modalAbrechnung').classList.remove('hidden');
}

// Event-Listener f√ºr ‚ÄûBezahlt"-Button
document.getElementById('btnPaid').addEventListener('click', () => {
  if (!aktuelleAbrechnungRow) return;

  const tipAmount = parseFloat(document.getElementById('inputTip').value) || 0;
  aktuelleAbrechnungRow.setAttribute('data-tip', tipAmount.toFixed(2));

  // 1. Markiere als abgerechnet
  aktuelleAbrechnungRow.classList.add('bg-green-100');
  aktuelleAbrechnungRow.setAttribute('data-paid', 'true');

  // 2. Name-Feld deaktivieren
  const nameInput = aktuelleAbrechnungRow.querySelector('input[type="text"]');
  if (nameInput) {
    nameInput.setAttribute('disabled', 'true');
    nameInput.classList.add('bg-gray-200');
  }

  // 3. Getr√§nke Button deaktivieren
  const btnGetraenke = aktuelleAbrechnungRow.querySelector('.btnAddGetraenke');
  if (btnGetraenke) {
    btnGetraenke.setAttribute('disabled', 'true');
    btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 4. Essen Button deaktivieren
  const btnEssen = aktuelleAbrechnungRow.querySelector('.btnAddEssen');
  if (btnEssen) {
    btnEssen.setAttribute('disabled', 'true');
    btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 5. Abrechnen Button deaktivieren
  const btnAbrechnen = aktuelleAbrechnungRow.querySelector('.btnAbrechnen');
  if (btnAbrechnen) {
    btnAbrechnen.setAttribute('disabled', 'true');
    btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 6. L√∂schbutton durch gr√ºnen Haken ersetzen
  const lastTd = aktuelleAbrechnungRow.querySelectorAll('td')[5];
  if (lastTd) {
    lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
  }

  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
  updateFinalizeButtonState();
});

function updateFinalizeButtonState() {
  const rows = document.querySelectorAll('#tab_Gaeste tbody tr');
  if (rows.length === 0) return;

  // Pr√ºfe ob alle G√§ste mit Namen auch bezahlt haben
  const gaesteWithNames = Array.from(rows).filter(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    return name !== '';
  });

  const allPaid = gaesteWithNames.length > 0 && gaesteWithNames.every(row => row.getAttribute('data-paid') === 'true');

  const btn = document.getElementById('btnFinalizeGame');
  if (!btn) return;

  if (allPaid) {
    btn.disabled = false;
    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
  } else {
    btn.disabled = true;
    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
  }
}

// Speichern des gesamten Spiels
document.getElementById('btnSaveGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
    alert('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).');
    return;
  }

  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) { // Nur G√§ste mit Namen speichern
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  // Status bestimmen: ready wenn alle G√§ste bezahlt haben, sonst draft
  const allPaid = gaeste.length > 0 && gaeste.every(gast => gast.paid);
  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: allPaid ? 'ready' : 'draft' 
  };

  if (editIndex !== null) {
    // Update bestehendes Spiel
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId; // Firebase-ID beibehalten
    gespeicherteSpiele[editIndex] = spielData;
    
    // In Firebase aktualisieren
    if (spielData.firebaseId) {
      await updateGameInFirebase(spielData.firebaseId, spielData);
    }
    
    editIndex = null;
  } else {
    // Neues Spiel speichern
    const firebaseId = await saveGameToFirebase(spielData);
    if (firebaseId) {
      spielData.firebaseId = firebaseId;
    }
    gespeicherteSpiele.push(spielData);
  }

  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  // Erfolgs-Nachricht
  const statusText = spielData.status === 'ready' ? 'bereit f√ºr Abrechnung' : 'als Entwurf gespeichert';
  alert(`Spiel wurde ${statusText}!`);
});

// PDF-Erstellung f√ºr Spiel-Abrechnung (Final-Abrechnung)
document.getElementById('btnFinalizeGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
    alert('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).');
    return;
  }

  // Erst das Spiel als finalized speichern
  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) {
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: 'finalized',
    finalizedAt: new Date().toISOString()
  };

  // PDF erstellen
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const tableData = [];
  const drinksSummary = {};
  const foodSummary = {};
  let totalAmount = 0;
  let totalTip = 0;

  gaeste.forEach(gast => {
    const getraenke = JSON.parse(gast.getraenke || '{}');
    const essen = JSON.parse(gast.essen || '{}');
    
    // Berechne Betrag f√ºr diesen Gast
    let gastBetrag = 0;
    
    // Getr√§nke berechnen
    for (let [name, menge] of Object.entries(getraenke)) {
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        gastBetrag += getraenk.preis * menge;
      }
    }
    
    // Essen berechnen
    for (let [name, menge] of Object.entries(essen)) {
      const essenItem = essenListe.find(e => e.name === name);
      if (essenItem) {
        gastBetrag += essenItem.preis * menge;
      }
    }

    const tip = parseFloat(gast.tip || '0');
    totalAmount += gastBetrag;
    totalTip += tip;

    // Getr√§nke Text + Summen berechnen
    let getraenkeText = '';
    for (let [k, v] of Object.entries(getraenke)) {
      if (v > 0) {
        getraenkeText += `${k} (${v}) `;
        drinksSummary[k] = (drinksSummary[k] || 0) + v;
      }
    }

    // Essen Text + Summen berechnen
    let essenText = '';
    for (let [k, v] of Object.entries(essen)) {
      if (v > 0) {
        essenText += `${k} (${v}) `;
        foodSummary[k] = (foodSummary[k] || 0) + v;
      }
    }

    tableData.push([
      gast.name, 
      getraenkeText.trim() || '-', 
      essenText.trim() || '-', 
      gastBetrag.toFixed(2) + ' ‚Ç¨', 
      tip.toFixed(2) + ' ‚Ç¨'
    ]);
  });

  // Summenzeile
  const getraenkeSumme = Object.entries(drinksSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';
  const essenSumme = Object.entries(foodSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';

  tableData.push([
    'SUMME', 
    getraenkeSumme, 
    essenSumme, 
    totalAmount.toFixed(2) + ' ‚Ç¨', 
    totalTip.toFixed(2) + ' ‚Ç¨'
  ]);

  // PDF erstellen
  doc.setFontSize(16);
  doc.text(`Abrechnung: ${team} vs ${opponent}`, 10, 15);
  doc.setFontSize(12);
  doc.text(`Datum: ${formatDate(date)}`, 10, 25);

  doc.autoTable({
    head: [['Name', 'Getr√§nke', 'Essen', 'Zwischensumme', 'Trinkgeld']],
    body: tableData,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    startY: 35,
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  // Gesamtsumme am Ende
  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.text(`Gesamtumsatz: ${(totalAmount + totalTip).toFixed(2)} ‚Ç¨`, 10, finalY);

  // PDF als Base64 String f√ºr Firebase speichern
  const pdfData = doc.output('datauristring');

  // Spiel als finalized speichern/updaten
  let gameId;
  if (editIndex !== null) {
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId;
    gespeicherteSpiele[editIndex] = spielData;
    gameId = spielData.firebaseId;
    
    if (gameId) {
      await updateGameInFirebase(gameId, spielData);
    }
    editIndex = null;
  } else {
    gameId = await saveGameToFirebase(spielData);
    if (gameId) {
      spielData.firebaseId = gameId;
    }
    gespeicherteSpiele.push(spielData);
  }

  // PDF in Firebase speichern
  if (gameId) {
    await savePDFToFirebase(gameId, pdfData);
    // Lokale Daten auch aktualisieren
    const localGame = gespeicherteSpiele.find(g => g.firebaseId === gameId);
    if (localGame) {
      localGame.pdfData = pdfData;
      localGame.pdfCreatedAt = new Date().toISOString();
    }
  }

  // PDF im Browser √∂ffnen
  const newWindow = window.open();
  newWindow.document.write(`<iframe src="${pdfData}" width="100%" height="100%"></iframe>`);

  // UI aktualisieren und Modal schlie√üen
  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  alert('Spiel wurde final abgerechnet und PDF wurde erstellt!');
});

// PDF anzeigen Funktion
function showPDF(index) {
  const spiel = gespeicherteSpiele[index];
  if (spiel.pdfData) {
    const newWindow = window.open();
    newWindow.document.write(`<iframe src="${spiel.pdfData}" width="100%" height="100%"></iframe>`);
  } else {
    alert('F√ºr dieses Spiel ist kein PDF verf√ºgbar.');
  }
}

function renderGames() {
  const container = document.getElementById('gamesContainer');
  container.innerHTML = '';

  if (gespeicherteSpiele.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center">Noch keine Spiele gespeichert.</p>';
    return;
  }

  gespeicherteSpiele.forEach((spiel, index) => {
    const div = document.createElement('div');
    div.className = 'bg-white shadow p-4 mb-2 flex justify-between items-center rounded hover:shadow-md transition-shadow';

    // Status bestimmen
    const isFinalized = spiel.status === 'finalized';
    const isReady = spiel.status === 'ready';
    const hasPDF = spiel.pdfData;
    
    let statusIcon, statusText;
    if (isFinalized) {
      statusIcon = '<span class="text-green-600 text-lg font-bold">‚úì</span>';
      statusText = '<span class="text-xs text-green-600 font-medium">ABGERECHNET</span>';
    } else if (isReady) {
      statusIcon = '<span class="text-blue-600 text-lg">‚úì</span>';
      statusText = '<span class="text-xs text-blue-600 font-medium">BEREIT F√úR ABRECHNUNG</span>';
    } else {
      statusIcon = '<span class="text-orange-500 text-lg">‚è≥</span>';
      statusText = '<span class="text-xs text-orange-600 font-medium">ENTWURF</span>';
    }

    div.innerHTML = `
      <div>
        <div class="flex items-center space-x-2">
          <strong>${spiel.team || 'Unbekanntes Team'}</strong> 
          <span class="text-gray-400">vs</span>
          <span>${spiel.opponent || 'Unbekannter Gegner'}</span>
          ${statusIcon}
        </div>
        <div class="flex items-center space-x-3 mt-1">
          <span class="text-sm text-gray-500">${formatDate(spiel.date)}</span>
          <span class="text-sm text-gray-500">(${spiel.gaeste ? spiel.gaeste.length : 0} G√§ste)</span>
          ${statusText}
        </div>
      </div>
      <div class="flex space-x-2">
        ${hasPDF ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="showPDF(${index})" title="PDF anzeigen">üìÑ</button>` : ''}
        ${!isFinalized ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="editGame(${index})" title="Bearbeiten">‚úèÔ∏è</button>` : ''}
        ${!isFinalized ? `<button class="text-red-600 hover:text-red-800 text-lg" onclick="deleteGame(${index})" title="L√∂schen">üóëÔ∏è</button>` : ''}
      </div>
    `;

    container.appendChild(div);
  });
}

function editGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere Bearbeitung von finalisierten Spielen
  if (spiel.status === 'finalized') {
    alert('Dieses Spiel ist bereits final abgerechnet und kann nicht mehr bearbeitet werden.');
    return;
  }
  
  editIndex = index;

  document.getElementById('selectTeam').value = spiel.team || '';
  document.getElementById('inputOpponent').value = spiel.opponent || '';
  document.getElementById('inputDate').value = spiel.date || '';

  // G√§ste laden
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  
  if (spiel.gaeste && spiel.gaeste.length > 0) {
    spiel.gaeste.forEach(gast => {
      addGuestRow();
      const lastRow = tbody.lastChild;
      lastRow.querySelector('input[type="text"]').value = gast.name || '';
      if (gast.getraenke) lastRow.setAttribute('data-getraenke', gast.getraenke);
      if (gast.essen) lastRow.setAttribute('data-essen', gast.essen);
      if (gast.tip) lastRow.setAttribute('data-tip', gast.tip);
      
      updateGesamtbetrag(lastRow);
      
      if (gast.paid) {
        lastRow.classList.add('bg-green-100');
        lastRow.setAttribute('data-paid', 'true');

        const nameInput = lastRow.querySelector('input[type="text"]');
        if (nameInput) {
          nameInput.setAttribute('disabled', 'true');
          nameInput.classList.add('bg-gray-200');
        }

        const btnGetraenke = lastRow.querySelector('.btnAddGetraenke');
        if (btnGetraenke) {
          btnGetraenke.setAttribute('disabled', 'true');
          btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnEssen = lastRow.querySelector('.btnAddEssen');
        if (btnEssen) {
          btnEssen.setAttribute('disabled', 'true');
          btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnAbrechnen = lastRow.querySelector('.btnAbrechnen');
        if (btnAbrechnen) {
          btnAbrechnen.setAttribute('disabled', 'true');
          btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
          btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const lastTd = lastRow.querySelectorAll('td')[5];
        if (lastTd) {
          lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
        }
      }
    });
  } else {
    // Fallback: mindestens 4 leere Zeilen
    for (let i = 0; i < 4; i++) addGuestRow();
  }

  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
}

function deleteGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere L√∂schen von finalisierten Spielen
  if (spiel.status === 'finalized') {
    alert('Finalisierte Spiele k√∂nnen nicht gel√∂scht werden.');
    return;
  }
  
  if (confirm('Sind Sie sicher, dass Sie dieses Spiel l√∂schen m√∂chten?')) {
    // Aus Firebase l√∂schen wenn Firebase-ID vorhanden
    if (spiel.firebaseId) {
      deleteGameFromFirebase(spiel.firebaseId).then(success => {
        if (success) {
          console.log('Spiel erfolgreich aus Firebase gel√∂scht');
        } else {
          console.warn('Fehler beim L√∂schen aus Firebase, aber lokaler Eintrag wird trotzdem entfernt');
        }
      });
    }
    
    // Aus lokaler Liste entfernen
    gespeicherteSpiele.splice(index, 1);
    renderGames();
    
    // Erfolgs-Nachricht
    alert('Spiel wurde gel√∂scht!');
  }
}

// Beim Laden der Seite Firebase-Daten laden
window.addEventListener('load', () => {
  // Kurz warten bis Firebase initialisiert ist
  setTimeout(() => {
    loadGamesFromFirebase();
  }, 1000);
});

// Eingabe-Validierung f√ºr Zahlenfelder
document.addEventListener('input', (e) => {
  if (e.target.type === 'number') {
    const value = parseFloat(e.target.value);
    if (isNaN(value) || value < 0) {
      e.target.value = 0;
    }
  }
});

// Keyboard-Shortcuts
document.addEventListener('keydown', (e) => {
  // ESC zum Schlie√üen von Modals
  if (e.key === 'Escape') {
    document.querySelectorAll('.fixed').forEach(modal => {
      if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    });
    
    // Reset aktuelle Variablen
    aktuelleGetraenkeRow = null;
    aktuelleEssenRow = null;
    aktuelleAbrechnungRow = null;
  }
});

// Modal-Hintergrund-Klicks zum Schlie√üen
document.querySelectorAll('.fixed').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      aktuelleGetraenkeRow = null;
      aktuelleEssenRow = null;
      aktuelleAbrechnungRow = null;
    }
  });
});

</script>
</body>
</html>