<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heimspielabrechnung The Deers</title>
  <link rel="icon" type="image/svg" href="The Deers Logo nur Hirsch.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase v10 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
	import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyD5B4C8EiEdLA2XWLzb2JvcFi9DAnV1M7E",
      authDomain: "thedeersabrechnung.firebaseapp.com",
      projectId: "thedeersabrechnung",
      storageBucket: "thedeersabrechnung.firebasestorage.app",
      messagingSenderId: "27261468983",
      appId: "1:27261468983:web:1a6340756263aad9455ab2",
      measurementId: "G-6KBNXWTYJ1"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
	const auth = getAuth(app);

// Firebase Funktionen global verf√ºgbar machen
window.firebaseDB = db;
window.firebaseAuth = auth;
window.firebaseUtils = { collection, addDoc, getDocs, updateDoc, doc, deleteDoc };
window.authUtils = { signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut };
window.firebaseReady = true;

// Auth State Observer
onAuthStateChanged(auth, (user) => {
  console.log('Auth state changed:', user ? 'Benutzer angemeldet' : 'Benutzer abgemeldet');
  window.currentFirebaseUser = user;
  
  if (user) {
    // Benutzer ist angemeldet
    console.log('Angemeldet als:', user.email);
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Warte kurz bis DOM ready ist
    setTimeout(() => {
      loadGamesFromFirebase();
      showPage('home'); // Stelle sicher dass eine Seite aktiv ist
    }, 100);
  } else {
    // Benutzer ist nicht angemeldet
    console.log('Benutzer abgemeldet');
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }
});

// Event f√ºr Firebase-Initialisierung
window.dispatchEvent(new Event('firebaseReady'));
  </script>
  <style>
    .modal-game-background {
      background-image: url('The Deers Logo dunkelgrau-hellgrau.svg');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: contain;
      background-attachment: fixed;
      position: relative;
    }
    
    .modal-game-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      z-index: 1;
    }
    
    .modal-game-content {
      position: relative;
      z-index: 2;
    }
	/* Toast Styles */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #16A34A;
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  font-weight: 500;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
  max-width: 500px;
  text-align: center;
}

.toast.show {
  opacity: 1;
}

.toast.error {
  background-color: #DC2626;
}

.toast.warning {
  background-color: #f59e0b;
}

/* Login Styles */
.login-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f7f8f9;
  background-image: 
    repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      #e5e7eb 2px,
      #e5e7eb 4px
    ),
    repeating-linear-gradient(
      60deg,
      transparent,
      transparent 2px,
      #e5e7eb 2px,
      #e5e7eb 4px
    ),
    repeating-linear-gradient(
      120deg,
      transparent,
      transparent 2px,
      #e5e7eb 2px,
      #e5e7eb 4px
    );
}

.login-form {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 400px;
}

.login-input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e1e5e9;
  border-radius: 6px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}

.login-input:focus {
  outline: none;
  border-color: #667eea;
}

.login-button {
  width: 100%;
  padding: 12px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.login-button:hover {
  background: #5a67d8;
}

.login-button:disabled {
  background: #a0aec0;
  cursor: not-allowed;
}

.hidden {
  display: none !important;
}
  </style>
</head>
<body class="bg-gray-100 p-6">

<!-- Login Seite -->
<div id="loginPage" class="login-container">
  <div class="login-form">
    <div class="text-center mb-8">
      <img src="The Deers Logo A4.svg" alt="Logo" class="h-20 w-auto mx-auto mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Heimspielabrechnung</h1>
      <h2 class="text-lg text-gray-600">The Deers - TSV Hirschaid</h2>
    </div>
    
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700">E-Mail</label>
        <input type="email" id="loginEmail" class="login-input" placeholder="E-Mail eingeben" required>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2 text-gray-700">Passwort</label>
        <input type="password" id="loginPassword" class="login-input" placeholder="Passwort eingeben" required>
      </div>
      
      <button type="submit" id="loginButton" class="login-button">Anmelden</button>
      
      <div id="loginError" class="text-red-600 text-sm text-center hidden mt-2"></div>
    </form>
	</div>
</div>

<!-- Haupt-App (wird nach Login angezeigt) -->
<div id="mainApp" class="hidden">

<!-- Kopfbereich mit Logo + Titel -->
<div class="relative mb-8">
  <!-- Logo responsive positioniert -->
  <div class="absolute top-0 right-5">
    <img src="The Deers Logo A4.svg" alt="Logo" class="h-44 w-auto">
  </div>
  <div class="text-center pr-0 sm:pr-48">
    <h1 class="text-2xl sm:text-4xl font-bold text-gray-800 mb-2">Heimspielabrechnung The Deers</h1>
    <h2 class="text-xl sm:text-3xl text-gray-600">TSV Hirschaid</h2>
  </div>
</div>

  <nav class="mb-6" align="center">
  <button id="btn-home" onclick="showPage('home')" class="nav-btn bg-gray-400 text-white px-4 py-2 rounded mb-4 hover:bg-gray-400 font-bold" style="width: 150px;">Heimspiele</button>
  <button id="btn-reports" onclick="showPage('reports')" class="nav-btn bg-gray-300 text-white px-4 py-2 rounded mb-4 hover:bg-gray-400 font-bold" style="width: 150px;">Auswertungen</button>
  <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 font-bold" style="width: 150px;">Abmelden</button>
</nav>
<div id="page-home">
  <!-- Button: Neues Heimspiel -->
  <button id="btnNewGame" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">Neues Heimspiel</button>

  <!-- Container f√ºr gespeicherte Formulare -->
  <div id="gamesContainer"></div>

  <!-- Modal: Spiel -->
  <div id="modalGame" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-game-background">
     <div class="modal-game-content"> 
	  <h2 class="text-xl font-bold mb-4">Spiel</h2>

      <div class="flex space-x-4 mb-4">
        <!-- Dropdown Team -->
        <div>
          <label class="block text-sm font-medium mb-1">Team</label>
          <select id="selectTeam" class="border rounded w-40 p-2">
            <option value="">Bitte w√§hlen</option>
            <option value="TheDeers I">TheDeers I</option>
            <option value="TheDeers II">TheDeers II</option>
            <option value="TheDeers III">TheDeers III</option>
            <option value="TheDeers IV">TheDeers IV</option>
          </select>
        </div>

        <!-- Gegner -->
        <div>
          <label class="block text-sm font-medium mb-1">Gegner</label>
          <input type="text" id="inputOpponent" class="border rounded w-40 p-2" />
        </div>

        <!-- Datum -->
        <div>
          <label class="block text-sm font-medium mb-1">Datum</label>
          <input type="date" id="inputDate" class="border rounded w-40 p-2" />
        </div>
      </div>

      <!-- Tabelle G√§ste -->
      <table class="w-full text-sm mb-4" id="tab_Gaeste">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Getr√§nke</th>
            <th class="p-2 border">Essen</th>
            <th class="p-2 border">Gesamtbetrag</th>
            <th class="p-2 border">Abrechnung</th>
            <th class="p-2 border">Aktion</th>
          </tr>
        </thead>
        <tbody>
          <!-- Zeilen werden dynamisch hinzugef√ºgt -->
        </tbody>
      </table>
      <button id="addGuestRow" class="text-blue-600 mb-4 hover:text-blue-800">+ Gast hinzuf√ºgen</button>

      <!-- Spiel abrechnen, Speichern & Schlie√üen -->
      <div class="flex justify-end space-x-2">
        <button id="btnFinalizeGame" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded" disabled>Spiel abrechnen</button>
        <button id="btnSaveGame" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGame" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>

    </div>
  </div>

  <!-- Modal: Getr√§nke -->
  <div id="modalGetraenke" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Getr√§nke</h2>
      <table class="w-full text-sm mb-4" id="tab_Getraenke">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Preis</th>
            <th class="p-2 border">Anzahl</th>
            <th class="p-2 border">Zwischensumme</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamisch bef√ºllt -->
        </tbody>
      </table>
      <div class="mb-4 font-semibold">Summe Getr√§nke: <span id="summe_Getraenke">0.00</span> ‚Ç¨</div>
      <div class="flex justify-end space-x-2">
        <button id="btnSaveGetraenke" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGetraenke" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>
    </div>
  </div>

<!-- Modal: Essen -->
<div id="modalEssen" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">Essen</h2>
    <table class="w-full text-sm mb-4" id="tab_Essen">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 border">Name</th>
          <th class="p-2 border">Preis</th>
          <th class="p-2 border">Anzahl</th>
          <th class="p-2 border">Zwischensumme</th>
        </tr>
      </thead>
      <tbody>
        <!-- Dynamisch per JS bef√ºllt -->
      </tbody>
    </table>
    <div class="mb-4 font-semibold">Summe Essen: <span id="summe_Essen">0.00</span> ‚Ç¨</div>
    <div class="flex justify-end space-x-2">
      <button id="btnSaveEssen" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
      <button id="btnCloseEssen" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Abrechnung -->
<div id="modalAbrechnung" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">Abrechnung</h2>
    <div id="abrechnungContent"></div>
    <div class="my-4">
      <label class="block text-sm font-medium mb-1">Trinkgeld (‚Ç¨)</label>
      <div class="flex items-center space-x-2">
        <button type="button" class="bg-yellow-400 hover:bg-yellow-600 text-white px-2 py-2 rounded font-semibold text-sm" id="btnAdd50Cent" title="50 Cent hinzuf√ºgen">
          ü™ô +0,50
        </button>
        <button type="button" class="bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-2 rounded font-semibold text-sm" id="btnAdd1Euro" title="1 Euro hinzuf√ºgen">
          ü™ô +1,00
        </button>
        <input type="number" id="inputTip" class="border rounded flex-1 p-2 text-right" step="0.01" min="0" value="0.00" />
      </div>
	    <!-- Sch√∂nes Hinweisfenster -->
  <div class="mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3">
    <div class="flex items-center">
      <span class="text-2xl mr-3">üí°</span>
      <div class="flex-1">
        <p class="text-blue-800 text-sm font-medium">
          Das Trinkgeld kommt direkt in die Sau üê∑
        </p>
      </div>
    </div>
  </div>
    </div>
    <div class="flex justify-end space-x-2">
      <button id="btnPaid" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Bezahlt</button>
      <button id="btnCloseAbrechnung" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>
</div>

<script>

let confirmCallback = null; // F√ºr Best√§tigungsmodal

// Toast-Funktionen
function showToast(message, type = 'success') {
  // Entferne existierende Toasts
  const existingToasts = document.querySelectorAll('.toast');
  existingToasts.forEach(toast => toast.remove());

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  // Toast anzeigen
  setTimeout(() => toast.classList.add('show'), 100);

  // Toast nach 3 Sekunden ausblenden
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function showConfirm(message, callback, confirmText = 'L√∂schen') {
  document.getElementById('confirmMessage').textContent = message;
  document.getElementById('btnConfirmOk').textContent = confirmText;
  confirmCallback = callback;
  document.getElementById('modalConfirm').classList.remove('hidden');
}

let gespeicherteSpiele = [];
let editIndex = null;
let aktuelleGetraenkeRow = null;
let aktuelleEssenRow = null;
let aktuelleAbrechnungRow = null;

// Getr√§nke und Essen Daten
const getraenkeListe = [
  { name: 'Softdrink/Wasser', preis: 2.50 },
  { name: 'Bier des Monats', preis: 3.50 },
  { name: 'Krausenbier', preis: 3.00 },
  { name: 'Weizen', preis: 3.50 },
  { name: 'Winzerschorle', preis: 4.50 },
  { name: 'Kaffee/Tee', preis: 1.50 },
  { name: 'Cola', preis: 2.50 }
];

const essenListe = [
  { name: 'Pizza', preis: 9.00 },
  { name: 'Chicken Nuggets', preis: 5.00 },
  { name: 'Chilli Cheese Nuggets', preis: 5.00 },
  { name: 'Riegel', preis: 1.00 }
];

// Hilfsfunktion zum Runden auf 2 Nachkommastellen
function round2(num) {
  return Math.round(num * 100) / 100;
}

// Hilfsfunktion f√ºr Datumsformatierung
function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split("-");
  return `${day}.${month}.${year}`;
}

// Firebase Funktionen
async function saveGameToFirebase(spielData) {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return null;
    }
    
    const docRef = await window.firebaseUtils.addDoc(
      window.firebaseUtils.collection(window.firebaseDB, "spiele"), 
      {
        ...spielData,
        timestamp: new Date().toISOString()
      }
    );
    console.log("Spiel in Firebase gespeichert mit ID: ", docRef.id);
    return docRef.id;
  } catch (error) {
    console.error("Fehler beim Speichern in Firebase: ", error);
    return null;
  }
}

async function updateGameInFirebase(gameId, spielData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      ...spielData,
      lastUpdated: new Date().toISOString()
    });
    console.log("Spiel in Firebase aktualisiert:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Aktualisieren in Firebase: ", error);
    return false;
  }
}

async function deleteGameFromFirebase(gameId) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.deleteDoc(gameRef);
    console.log("Spiel aus Firebase gel√∂scht:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim L√∂schen aus Firebase: ", error);
    return false;
  }
}

async function loadGamesFromFirebase() {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return;
    }
    
    const querySnapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );
    
    gespeicherteSpiele = [];
    querySnapshot.forEach((doc) => {
      gespeicherteSpiele.push({
        id: doc.id,
        firebaseId: doc.id,
        ...doc.data()
      });
    });
    
    renderGames();
  } catch (error) {
    console.error("Fehler beim Laden aus Firebase: ", error);
  }
}

// PDF in Firebase speichern
async function savePDFToFirebase(gameId, pdfData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      pdfData: pdfData,
      pdfCreatedAt: new Date().toISOString()
    });
    console.log("PDF in Firebase gespeichert f√ºr Spiel:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Speichern des PDFs in Firebase: ", error);
    return false;
  }
}

// Event Listeners
document.getElementById('btnNewGame').addEventListener('click', () => {
  editIndex = null;
  clearGameForm();
  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
  document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  initializeGaesteTable();
});

document.getElementById('btnCloseGame').addEventListener('click', () => {
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
});

document.getElementById('btnCloseGetraenke').addEventListener('click', () => {
  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

document.getElementById('btnCloseEssen').addEventListener('click', () => {
  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

document.getElementById('btnCloseAbrechnung').addEventListener('click', () => {
  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
});

document.getElementById('addGuestRow').addEventListener('click', addGuestRow);

// Form zur√ºcksetzen
function clearGameForm() {
  document.getElementById('selectTeam').value = '';
  document.getElementById('inputOpponent').value = '';
  document.getElementById('inputDate').value = '';
  document.querySelector('#tab_Gaeste tbody').innerHTML = '';
}

function initializeGaesteTable() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  for (let i = 0; i < 4; i++) addGuestRow();
}

function addGuestRow() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td class="border p-2">
      <input type="text" class="border rounded w-full p-1" placeholder="Name" />
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddGetraenke hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddEssen hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2 summeGesamt text-right">0.00 ‚Ç¨</td>
    <td class="border p-2">
      <button class="bg-gray-500 text-white px-2 py-1 rounded btnAbrechnen hover:bg-gray-600">Abrechnen</button>
    </td>
    <td class="border p-2 text-center">
      <button class="bg-red-600 text-white px-2 py-1 rounded btnDeleteGuest hover:bg-red-700">X</button>
    </td>
  `;
  tbody.appendChild(row);

  // Event-Listener f√ºr Buttons in der neuen Zeile
  row.querySelector('.btnAddGetraenke').addEventListener('click', () => openGetraenkeModal(row));
  row.querySelector('.btnAddEssen').addEventListener('click', () => openEssenModal(row));
  row.querySelector('.btnAbrechnen').addEventListener('click', () => openAbrechnungModal(row));
  row.querySelector('.btnDeleteGuest').addEventListener('click', () => {
    row.remove();
    updateFinalizeButtonState();
  });
}

// Getr√§nke Modal √∂ffnen
function openGetraenkeModal(row) {
  aktuelleGetraenkeRow = row;
  const tbody = document.querySelector('#tab_Getraenke tbody');
  tbody.innerHTML = '';

  // Lade bereits vorhandene Getr√§nke aus Daten-Attribut
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  let getraenkeData = gespeicherteGetraenke ? JSON.parse(gespeicherteGetraenke) : {};

  getraenkeListe.forEach((getraenk) => {
    const menge = getraenkeData[getraenk.name] || 0;
    const zwischensumme = round2(getraenk.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 border">${getraenk.name}</td>
      <td class="p-2 border text-right">${getraenk.preis.toFixed(2)} ‚Ç¨</td>
      <td class="p-2 border text-center">
        <div class="flex items-center justify-center space-x-2">
          <input type="number" min="0" value="${menge}" class="inputAnzahl border rounded w-16 text-center p-1" data-preis="${getraenk.preis}" />
          <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded font-semibold btnPlus1" title="Anzahl um 1 erh√∂hen">+1</button>
        </div>
      </td>
      <td class="p-2 border zwischensumme text-right">${zwischensumme} ‚Ç¨</td>
    `;
    tbody.appendChild(tr);

    // Event f√ºr Eingabe √Ñnderung
    tr.querySelector('.inputAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum + ' ‚Ç¨';
      updateGetraenkeSumme();
    });

    // Event f√ºr +1 Button
    tr.querySelector('.btnPlus1').addEventListener('click', () => {
      const inputField = tr.querySelector('.inputAnzahl');
      const currentValue = parseInt(inputField.value) || 0;
      inputField.value = currentValue + 1;
      
      // Trigger das input event um die Summe zu aktualisieren
      const event = new Event('input');
      inputField.dispatchEvent(event);
    });
  });

  updateGetraenkeSumme();
  document.getElementById('modalGetraenke').classList.remove('hidden');
}

function updateGetraenkeSumme() {
  const tbody = document.querySelector('#tab_Getraenke tbody');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent.replace(' ‚Ç¨', '');
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Getraenke').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveGetraenke').addEventListener('click', () => {
  if (!aktuelleGetraenkeRow) return;

  const tbody = document.querySelector('#tab_Getraenke tbody');
  const getraenkeData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputAnzahl').value) || 0;
    if (menge > 0) {
      getraenkeData[name] = menge;
    }
  });

  aktuelleGetraenkeRow.setAttribute('data-getraenke', JSON.stringify(getraenkeData));
  updateGesamtbetrag(aktuelleGetraenkeRow);

  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

// Essen Modal √∂ffnen
function openEssenModal(row) {
  aktuelleEssenRow = row;
  const tbody = document.querySelector('#tab_Essen tbody');
  tbody.innerHTML = '';

  // Lade gespeicherte Essen-Daten
  let gespeicherteEssen = row.getAttribute('data-essen');
  let essenData = gespeicherteEssen ? JSON.parse(gespeicherteEssen) : {};

  essenListe.forEach(item => {
    const menge = essenData[item.name] || 0;
    const zwischensumme = round2(item.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 border">${item.name}</td>
      <td class="p-2 border text-right">${item.preis.toFixed(2)} ‚Ç¨</td>
      <td class="p-2 border text-center">
        <div class="flex items-center justify-center space-x-2">
          <input type="number" min="0" value="${menge}" class="inputEssenAnzahl border rounded w-16 text-center p-1" data-preis="${item.preis}" />
          <button class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded font-semibold btnEssenPlus1" title="Anzahl um 1 erh√∂hen">+1</button>
        </div>
      </td>
      <td class="p-2 border zwischensumme text-right">${zwischensumme} ‚Ç¨</td>
    `;
    tbody.appendChild(tr);

    // Event f√ºr Eingabe √Ñnderung
    tr.querySelector('.inputEssenAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum + ' ‚Ç¨';
      updateEssenSumme();
    });

    // Event f√ºr +1 Button
    tr.querySelector('.btnEssenPlus1').addEventListener('click', () => {
      const inputField = tr.querySelector('.inputEssenAnzahl');
      const currentValue = parseInt(inputField.value) || 0;
      inputField.value = currentValue + 1;
      
      // Trigger das input event um die Summe zu aktualisieren
      const event = new Event('input');
      inputField.dispatchEvent(event);
    });
  });

  updateEssenSumme();
  document.getElementById('modalEssen').classList.remove('hidden');
}

function updateEssenSumme() {
  const tbody = document.querySelector('#tab_Essen tbody');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent.replace(' ‚Ç¨', '');
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Essen').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveEssen').addEventListener('click', () => {
  if (!aktuelleEssenRow) return;

  const tbody = document.getElementById('tab_Essen');
  const essenData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputEssenAnzahl').value) || 0;
    if (menge > 0) {
      essenData[name] = menge;
    }
  });

  aktuelleEssenRow.setAttribute('data-essen', JSON.stringify(essenData));
  updateGesamtbetrag(aktuelleEssenRow);

  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

// Berechnung und Aktualisierung des Gesamtbetrags je Gast
function updateGesamtbetrag(row) {
  let sumGetraenke = 0;
  let sumEssen = 0;

  // Getr√§nke summieren
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    for (const name in getraenkeData) {
      const menge = getraenkeData[name];
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        sumGetraenke += getraenk.preis * menge;
      }
    }
  }

  // Essen summieren
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    for (const name in essenData) {
      const menge = essenData[name];
      const essen = essenListe.find(e => e.name === name);
      if (essen) {
        sumEssen += essen.preis * menge;
      }
    }
  }

  const summeGesamt = round2(sumGetraenke + sumEssen);
  row.querySelector('.summeGesamt').textContent = summeGesamt.toFixed(2) + ' ‚Ç¨';
}

// Abrechnung Modal √∂ffnen
function openAbrechnungModal(row) {
  aktuelleAbrechnungRow = row;
  const abrechnung = document.getElementById('abrechnungContent');
  const name = row.querySelector('input[type="text"]').value || '(unbekannt)';
  const summeText = row.querySelector('.summeGesamt').textContent || '0.00 ‚Ç¨';

  // Getr√§nke laden
  let getraenkeHtml = '<h3 class="font-semibold mt-2">Getr√§nke:</h3>';
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    if (Object.keys(getraenkeData).length === 0) {
      getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
    } else {
      getraenkeHtml += '<ul class="list-disc ml-5">';
      for (const nameGetr in getraenkeData) {
        const menge = getraenkeData[nameGetr];
        const getraenk = getraenkeListe.find(g => g.name === nameGetr);
        const preis = getraenk ? getraenk.preis : 0;
        getraenkeHtml += `<li>${nameGetr}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      getraenkeHtml += '</ul>';
    }
  } else {
    getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
  }

  // Essen laden
  let essenHtml = '<h3 class="font-semibold mt-2">Essen:</h3>';
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    if (Object.keys(essenData).length === 0) {
      essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
    } else {
      essenHtml += '<ul class="list-disc ml-5">';
      for (const nameEssen in essenData) {
        const menge = essenData[nameEssen];
        const essen = essenListe.find(e => e.name === nameEssen);
        const preis = essen ? essen.preis : 0;
        essenHtml += `<li>${nameEssen}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      essenHtml += '</ul>';
    }
  } else {
    essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
  }

  abrechnung.innerHTML = `
    <div class="bg-gray-50 p-3 rounded">
      <p><strong>Gast:</strong> ${name}</p>
      <p><strong>Gesamtbetrag:</strong> ${summeText}</p>
      ${getraenkeHtml}
      ${essenHtml}
    </div>
  `;

  // Trinkgeld-Feld auf 0.00 setzen
  document.getElementById('inputTip').value = '0.00';
  
  // Event-Listener f√ºr Trinkgeld-Buttons
  setupTipButtons();
  
  document.getElementById('modalAbrechnung').classList.remove('hidden');
}

// Trinkgeld-Buttons Setup
function setupTipButtons() {
  // Entferne alte Event-Listener falls vorhanden
  const btn50Cent = document.getElementById('btnAdd50Cent');
  const btn1Euro = document.getElementById('btnAdd1Euro');
  
  if (btn50Cent) {
    // Clone und ersetze um alte Event-Listener zu entfernen
    const new50CentBtn = btn50Cent.cloneNode(true);
    btn50Cent.parentNode.replaceChild(new50CentBtn, btn50Cent);
    
    new50CentBtn.addEventListener('click', () => {
      const tipInput = document.getElementById('inputTip');
      const currentValue = parseFloat(tipInput.value) || 0;
      const newValue = (currentValue + 0.50).toFixed(2);
      tipInput.value = newValue;
    });
  }
  
  if (btn1Euro) {
    // Clone und ersetze um alte Event-Listener zu entfernen
    const new1EuroBtn = btn1Euro.cloneNode(true);
    btn1Euro.parentNode.replaceChild(new1EuroBtn, btn1Euro);
    
    new1EuroBtn.addEventListener('click', () => {
      const tipInput = document.getElementById('inputTip');
      const currentValue = parseFloat(tipInput.value) || 0;
      const newValue = (currentValue + 1.00).toFixed(2);
      tipInput.value = newValue;
    });
  }
}

// Event-Listener f√ºr ‚ÄûBezahlt"-Button
document.getElementById('btnPaid').addEventListener('click', () => {
  if (!aktuelleAbrechnungRow) return;

  const tipAmount = parseFloat(document.getElementById('inputTip').value) || 0;
  aktuelleAbrechnungRow.setAttribute('data-tip', tipAmount.toFixed(2));

  // 1. Markiere als abgerechnet
  aktuelleAbrechnungRow.classList.add('bg-green-100');
  aktuelleAbrechnungRow.setAttribute('data-paid', 'true');

  // 2. Name-Feld deaktivieren
  const nameInput = aktuelleAbrechnungRow.querySelector('input[type="text"]');
  if (nameInput) {
    nameInput.setAttribute('disabled', 'true');
    nameInput.classList.add('bg-gray-200');
  }

  // 3. Getr√§nke Button deaktivieren
  const btnGetraenke = aktuelleAbrechnungRow.querySelector('.btnAddGetraenke');
  if (btnGetraenke) {
    btnGetraenke.setAttribute('disabled', 'true');
    btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 4. Essen Button deaktivieren
  const btnEssen = aktuelleAbrechnungRow.querySelector('.btnAddEssen');
  if (btnEssen) {
    btnEssen.setAttribute('disabled', 'true');
    btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 5. Abrechnen Button deaktivieren
  const btnAbrechnen = aktuelleAbrechnungRow.querySelector('.btnAbrechnen');
  if (btnAbrechnen) {
    btnAbrechnen.setAttribute('disabled', 'true');
    btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 6. L√∂schbutton durch gr√ºnen Haken ersetzen
  const lastTd = aktuelleAbrechnungRow.querySelectorAll('td')[5];
  if (lastTd) {
    lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
  }

  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
  updateFinalizeButtonState();
});

function updateFinalizeButtonState() {
  const rows = document.querySelectorAll('#tab_Gaeste tbody tr');
  if (rows.length === 0) return;

  // Pr√ºfe ob alle G√§ste mit Namen auch bezahlt haben
  const gaesteWithNames = Array.from(rows).filter(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    return name !== '';
  });

  const allPaid = gaesteWithNames.length > 0 && gaesteWithNames.every(row => row.getAttribute('data-paid') === 'true');

  const btn = document.getElementById('btnFinalizeGame');
  if (!btn) return;

  if (allPaid) {
    btn.disabled = false;
    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
  } else {
    btn.disabled = true;
    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
  }
}

// Speichern des gesamten Spiels
document.getElementById('btnSaveGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
	showToast('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).', 'error');
    return;
  }

  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) { // Nur G√§ste mit Namen speichern
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  // Status bestimmen: ready wenn alle G√§ste bezahlt haben, sonst draft
  const allPaid = gaeste.length > 0 && gaeste.every(gast => gast.paid);
  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: allPaid ? 'ready' : 'draft' 
  };

  if (editIndex !== null) {
    // Update bestehendes Spiel
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId; // Firebase-ID beibehalten
    gespeicherteSpiele[editIndex] = spielData;
    
    // In Firebase aktualisieren
    if (spielData.firebaseId) {
      await updateGameInFirebase(spielData.firebaseId, spielData);
    }
    
    editIndex = null;
  } else {
    // Neues Spiel speichern
    const firebaseId = await saveGameToFirebase(spielData);
    if (firebaseId) {
      spielData.firebaseId = firebaseId;
    }
    gespeicherteSpiele.push(spielData);
  }

  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  // Erfolgs-Nachricht
  const statusText = spielData.status === 'ready' ? 'bereit f√ºr Abrechnung' : 'als Entwurf gespeichert';
  showToast(`Spiel ist ${statusText}!`);
});

// PDF-Erstellung f√ºr Spiel-Abrechnung (Final-Abrechnung)
document.getElementById('btnFinalizeGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
    showToast('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).');
    return;
  }

  // Erst das Spiel als finalized speichern
  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) {
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: 'finalized',
    finalizedAt: new Date().toISOString()
  };

  // PDF erstellen
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const tableData = [];
  const drinksSummary = {};
  const foodSummary = {};
  let totalAmount = 0;
  let totalTip = 0;

  gaeste.forEach(gast => {
    const getraenke = JSON.parse(gast.getraenke || '{}');
    const essen = JSON.parse(gast.essen || '{}');
    
    // Berechne Betrag f√ºr diesen Gast
    let gastBetrag = 0;
    
    // Getr√§nke berechnen
    for (let [name, menge] of Object.entries(getraenke)) {
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        gastBetrag += getraenk.preis * menge;
      }
    }
    
    // Essen berechnen
    for (let [name, menge] of Object.entries(essen)) {
      const essenItem = essenListe.find(e => e.name === name);
      if (essenItem) {
        gastBetrag += essenItem.preis * menge;
      }
    }

    const tip = parseFloat(gast.tip || '0');
    totalAmount += gastBetrag;
    totalTip += tip;

    // Getr√§nke Text + Summen berechnen
    let getraenkeText = '';
    for (let [k, v] of Object.entries(getraenke)) {
      if (v > 0) {
        getraenkeText += `${k} (${v}) `;
        drinksSummary[k] = (drinksSummary[k] || 0) + v;
      }
    }

    // Essen Text + Summen berechnen
    let essenText = '';
    for (let [k, v] of Object.entries(essen)) {
      if (v > 0) {
        essenText += `${k} (${v}) `;
        foodSummary[k] = (foodSummary[k] || 0) + v;
      }
    }

    tableData.push([
      gast.name, 
      getraenkeText.trim() || '-', 
      essenText.trim() || '-', 
      gastBetrag.toFixed(2) + ' ‚Ç¨', 
      tip.toFixed(2) + ' ‚Ç¨'
    ]);
  });

  // Summenzeile
  const getraenkeSumme = Object.entries(drinksSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';
  const essenSumme = Object.entries(foodSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';

  tableData.push([
    'SUMME', 
    getraenkeSumme, 
    essenSumme, 
    totalAmount.toFixed(2) + ' ‚Ç¨', 
    totalTip.toFixed(2) + ' ‚Ç¨'
  ]);

  // PDF erstellen
  doc.setFontSize(16);
  doc.text(`Abrechnung: ${team} vs ${opponent}`, 10, 15);
  doc.setFontSize(12);
  doc.text(`Datum: ${formatDate(date)}`, 10, 25);

  doc.autoTable({
    head: [['Name', 'Getr√§nke', 'Essen', 'Zwischensumme', 'Trinkgeld']],
    body: tableData,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    startY: 35,
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  // Gesamtsumme am Ende
  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.text(`Gesamtumsatz: ${(totalAmount + totalTip).toFixed(2)} ‚Ç¨`, 10, finalY);

  // PDF als Base64 String f√ºr Firebase speichern
  const pdfData = doc.output('datauristring');

  // Spiel als finalized speichern/updaten
  let gameId;
  if (editIndex !== null) {
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId;
    gespeicherteSpiele[editIndex] = spielData;
    gameId = spielData.firebaseId;
    
    if (gameId) {
      await updateGameInFirebase(gameId, spielData);
    }
    editIndex = null;
  } else {
    gameId = await saveGameToFirebase(spielData);
    if (gameId) {
      spielData.firebaseId = gameId;
    }
    gespeicherteSpiele.push(spielData);
  }

  // PDF in Firebase speichern
  if (gameId) {
    await savePDFToFirebase(gameId, pdfData);
    // Lokale Daten auch aktualisieren
    const localGame = gespeicherteSpiele.find(g => g.firebaseId === gameId);
    if (localGame) {
      localGame.pdfData = pdfData;
      localGame.pdfCreatedAt = new Date().toISOString();
    }
  }

  // PDF im Browser √∂ffnen
  const newWindow = window.open();
  newWindow.document.write(`<iframe src="${pdfData}" width="100%" height="100%"></iframe>`);

  // UI aktualisieren und Modal schlie√üen
  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  showToast('Spiel wurde final abgerechnet und PDF wurde erstellt!');
});

// PDF anzeigen Funktion
function showPDF(index) {
  const spiel = gespeicherteSpiele[index];
  if (spiel.pdfData) {
    const newWindow = window.open();
    newWindow.document.write(`<iframe src="${spiel.pdfData}" width="100%" height="100%"></iframe>`);
  } else {
    showToast('F√ºr dieses Spiel ist kein PDF verf√ºgbar.', 'warning');
  }
}

function renderGames() {
  const container = document.getElementById('gamesContainer');
  container.innerHTML = '';

  if (gespeicherteSpiele.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center">Noch keine Spiele gespeichert.</p>';
    return;
  }

  // Sortierung: zuerst nach Spieldatum, dann nach timestamp/lastUpdated
  gespeicherteSpiele.sort((a, b) => {
    // Spieldatum vergleichen
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    if (dateA.getTime() !== dateB.getTime()) {
      return dateB - dateA; // neuestes Datum zuerst
    }

    // Falls Spieldatum gleich ‚Üí nach Anlage-/Updatezeit sortieren
    const tsA = new Date(a.lastUpdated || a.timestamp || 0);
    const tsB = new Date(b.lastUpdated || b.timestamp || 0);
    return tsA - tsB; // neueste √Ñnderung zuerst
  });

  gespeicherteSpiele.forEach((spiel, index) => {
    const div = document.createElement('div');
    div.className = 'bg-white shadow p-4 mb-2 flex justify-between items-center rounded hover:shadow-md transition-shadow';

    // Status bestimmen
    const isFinalized = spiel.status === 'finalized';
    const isReady = spiel.status === 'ready';
    const hasPDF = spiel.pdfData;
    
    let statusIcon, statusText;
    if (isFinalized) {
      statusIcon = '<span class="text-green-600 text-lg font-bold">‚úì</span>';
      statusText = '<span class="text-xs text-green-600 font-medium">ABGERECHNET</span>';
    } else if (isReady) {
      statusIcon = '<span class="text-blue-600 text-lg">‚úì</span>';
      statusText = '<span class="text-xs text-blue-600 font-medium">BEREIT F√úR ABRECHNUNG</span>';
    } else {
      statusIcon = '<span class="text-orange-500 text-lg">‚è≥</span>';
      statusText = '<span class="text-xs text-orange-600 font-medium">ENTWURF</span>';
    }

    div.innerHTML = `
      <div>
        <div class="flex items-center space-x-2">
          <strong>${spiel.team || 'Unbekanntes Team'}</strong> 
          <span class="text-gray-400">vs</span>
          <span>${spiel.opponent || 'Unbekannter Gegner'}</span>
          ${statusIcon}
        </div>
        <div class="flex items-center space-x-3 mt-1">
          <span class="text-sm text-gray-500">${formatDate(spiel.date)}</span>
          <span class="text-sm text-gray-500">(${spiel.gaeste ? spiel.gaeste.length : 0} G√§ste)</span>
          ${statusText}
        </div>
      </div>
      <div class="flex space-x-2">
        ${hasPDF ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="showPDF(${index})" title="PDF anzeigen">üìÑ</button>` : ''}
        ${!isFinalized ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="editGame(${index})" title="Bearbeiten">‚úèÔ∏è</button>` : ''}
        ${!isFinalized ? `<button class="text-red-600 hover:text-red-800 text-lg" onclick="deleteGame(${index})" title="L√∂schen">üóëÔ∏è</button>` : ''}
      </div>
    `;

    container.appendChild(div);
  });
}

function editGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere Bearbeitung von finalisierten Spielen
  if (spiel.status === 'finalized') {
    showToast('Dieses Spiel ist bereits final abgerechnet und kann nicht mehr bearbeitet werden.', 'warning');
    return;
  }
  
  editIndex = index;

  document.getElementById('selectTeam').value = spiel.team || '';
  document.getElementById('inputOpponent').value = spiel.opponent || '';
  document.getElementById('inputDate').value = spiel.date || '';

  // G√§ste laden
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  
  if (spiel.gaeste && spiel.gaeste.length > 0) {
    spiel.gaeste.forEach(gast => {
      addGuestRow();
      const lastRow = tbody.lastChild;
      lastRow.querySelector('input[type="text"]').value = gast.name || '';
      if (gast.getraenke) lastRow.setAttribute('data-getraenke', gast.getraenke);
      if (gast.essen) lastRow.setAttribute('data-essen', gast.essen);
      if (gast.tip) lastRow.setAttribute('data-tip', gast.tip);
      
      updateGesamtbetrag(lastRow);
      
      if (gast.paid) {
        lastRow.classList.add('bg-green-100');
        lastRow.setAttribute('data-paid', 'true');

        const nameInput = lastRow.querySelector('input[type="text"]');
        if (nameInput) {
          nameInput.setAttribute('disabled', 'true');
          nameInput.classList.add('bg-gray-200');
        }

        const btnGetraenke = lastRow.querySelector('.btnAddGetraenke');
        if (btnGetraenke) {
          btnGetraenke.setAttribute('disabled', 'true');
          btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnEssen = lastRow.querySelector('.btnAddEssen');
        if (btnEssen) {
          btnEssen.setAttribute('disabled', 'true');
          btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnAbrechnen = lastRow.querySelector('.btnAbrechnen');
        if (btnAbrechnen) {
          btnAbrechnen.setAttribute('disabled', 'true');
          btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
          btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const lastTd = lastRow.querySelectorAll('td')[5];
        if (lastTd) {
          lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
        }
      }
    });
  } else {
    // Fallback: mindestens 4 leere Zeilen
    for (let i = 0; i < 4; i++) addGuestRow();
  }

  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
}

function deleteGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere L√∂schen von finalisierten Spielen
  if (spiel.status === 'finalized') {
    showToast('Finalisierte Spiele k√∂nnen nicht gel√∂scht werden.', 'warning');
    return;
  }
  
  showConfirm('Sind Sie sicher, dass Sie dieses Spiel l√∂schen m√∂chten?', () => {
    // Aus Firebase l√∂schen wenn Firebase-ID vorhanden
    if (spiel.firebaseId) {
      deleteGameFromFirebase(spiel.firebaseId).then(success => {
        if (success) {
          console.log('Spiel erfolgreich aus Firebase gel√∂scht');
        } else {
          console.warn('Fehler beim L√∂schen aus Firebase, aber lokaler Eintrag wird trotzdem entfernt');
        }
      });
    }
    
    // Aus lokaler Liste entfernen
    gespeicherteSpiele.splice(index, 1);
    renderGames();
    
    // Erfolgs-Nachricht
    showToast('Spiel wurde gel√∂scht!');
  });
}

// Beim Laden der Seite Firebase-Daten laden
window.addEventListener('load', () => {
  console.log('Seite geladen');
  // Best√§tigungsmodal Event Listeners
document.getElementById('btnConfirmCancel').addEventListener('click', () => {
  document.getElementById('modalConfirm').classList.add('hidden');
  confirmCallback = null;
});

document.getElementById('btnConfirmOk').addEventListener('click', () => {
  if (confirmCallback) {
    confirmCallback();
    confirmCallback = null;
  }
  document.getElementById('modalConfirm').classList.add('hidden');
});
  
  // Standardseite festlegen (Startseite)
  showPage('home');
  
  // Firebase-ready Event listener
  window.addEventListener('firebaseReady', () => {
    console.log('Firebase ist bereit, lade Spiele...');
    loadGamesFromFirebase();
  });
  
  // Fallback: Versuche nach 2 Sekunden zu laden
  setTimeout(() => {
    if (window.firebaseReady) {
      loadGamesFromFirebase();
    }
  }, 2000);
});

// Eingabe-Validierung f√ºr Zahlenfelder
document.addEventListener('input', (e) => {
  if (e.target.type === 'number') {
    const value = parseFloat(e.target.value);
    if (isNaN(value) || value < 0) {
      e.target.value = 0;
    }
  }
});

// Keyboard-Shortcuts
document.addEventListener('keydown', (e) => {
  // ESC zum Schlie√üen von Modals
  if (e.key === 'Escape') {
    document.querySelectorAll('.fixed').forEach(modal => {
      if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    });
    
    // Reset aktuelle Variablen
    aktuelleGetraenkeRow = null;
    aktuelleEssenRow = null;
    aktuelleAbrechnungRow = null;
  }
});

// Modal-Hintergrund-Klicks zum Schlie√üen
document.querySelectorAll('.fixed').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      aktuelleGetraenkeRow = null;
      aktuelleEssenRow = null;
      aktuelleAbrechnungRow = null;
    }
  });
});

</script>
</div>
</div>
<!-- Seite 2: Auswertungen -->

<div id="page-reports" class="hidden">
  <h1 class="text-3xl font-bold mb-6">Auswertungen</h1>
  
  <!-- Filter-Bereich -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="flex items-center space-x-4">
      <div>
        <label class="block text-sm font-medium mb-1">Jahr filtern</label>
        <select id="filterYear" class="border rounded p-2">
          <option value="">Alle Jahre</option>
        </select>
      </div>
      <div>
        <button id="btnExportPDF" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Als PDF exportieren</button>
      </div>
    </div>
  </div>

  <!-- Auswertungstabelle -->
  <div class="bg-white shadow rounded overflow-hidden">
    <table id="reportsTable" class="min-w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-3 border font-semibold">Kalenderwoche</th>
          <th class="p-3 border font-semibold">Spiele</th>
          <th class="p-3 border font-semibold">Getr√§nke (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Essen (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Trinkgeld (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Summe (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Details</th>
        </tr>
      </thead>
      <tbody id="auswertungTableBody">
        <!-- Wird dynamisch bef√ºllt -->
      </tbody>
      <tfoot class="bg-gray-100">
        <tr class="font-bold">
          <td class="p-3 border">GESAMT</td>
          <td class="p-3 border text-center" id="totalSpiele">0</td>
          <td class="p-3 border text-right" id="totalGetraenke">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalEssen">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalTrinkgeld">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalSumme">0.00 ‚Ç¨</td>
          <td class="p-3 border"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Leer-Zustand -->
  <div id="noDataMessage" class="text-center py-8 text-gray-500 hidden">
    <p>Keine Daten f√ºr die Auswertung verf√ºgbar.</p>
  </div>
</div>

<!-- Modal: Wochendetails -->
<div id="modalWochendetails" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">Details f√ºr <span id="detailWeekTitle"></span></h2>
    
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Spiele in dieser Woche:</h3>
      <div id="detailSpiele" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkaufte Getr√§nke:</h3>
      <div id="detailGetraenke" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkauftes Essen:</h3>
      <div id="detailEssen" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="flex justify-end">
      <button id="btnCloseDetails" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
// Erweiterte loadReports Funktion (GEFIXT)
async function loadReports() {
  console.log('loadReports aufgerufen');
  
  try {
    // Warten bis Firebase bereit ist
    if (!window.firebaseReady || !window.firebaseDB) {
      console.log('Firebase noch nicht bereit, warte...');
      await new Promise(resolve => {
        if (window.firebaseReady) {
          resolve();
        } else {
          window.addEventListener('firebaseReady', resolve, { once: true });
          // Fallback timeout
          setTimeout(resolve, 3000);
        }
      });
    }

    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert nach Wartezeit');
      document.getElementById('noDataMessage').classList.remove('hidden');
      document.getElementById('reportsTable').classList.add('hidden');
      return;
    }

    console.log('Lade Spiele aus Firebase...');
    const snapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );

    const weeklyData = {};
    const allYears = new Set();

    console.log(`${snapshot.size} Spiele gefunden`);

    snapshot.forEach(doc => {
      const data = doc.data();
      console.log('Verarbeite Spiel:', data);
      
      if (!data.date || !data.gaeste || data.gaeste.length === 0) {
        console.log('Spiel √ºbersprungen - keine Daten oder G√§ste');
        return;
      }

      const date = new Date(data.date);
      const year = date.getFullYear();
      allYears.add(year);

      // Kalenderwoche berechnen (ISO 8601 Standard)
      const week = getISOWeek(date);
      const weekKey = `KW ${week}/${year}`;

      if (!weeklyData[weekKey]) {
        weeklyData[weekKey] = {
          week: week,
          year: year,
          spiele: [],
          getraenkeDetails: {},
          essenDetails: {},
          getraenkeUmsatz: 0,
          essenUmsatz: 0,
          trinkgeld: 0,
          sortDate: date
        };
      }

      // Spiel zur Woche hinzuf√ºgen
      weeklyData[weekKey].spiele.push({
        team: data.team || 'Unbekannt',
        opponent: data.opponent || 'Unbekannt',
        date: data.date
      });

      // G√§ste durchgehen und Ums√§tze berechnen
      data.gaeste.forEach(gast => {
        // Getr√§nke verarbeiten
        if (gast.getraenke) {
          try {
            const getraenkeData = JSON.parse(gast.getraenke);
            for (const [name, menge] of Object.entries(getraenkeData)) {
              if (menge > 0) {
                const getraenk = getraenkeListe.find(g => g.name === name);
                if (getraenk) {
                  weeklyData[weekKey].getraenkeDetails[name] =
                    (weeklyData[weekKey].getraenkeDetails[name] || 0) + menge;
                  weeklyData[weekKey].getraenkeUmsatz += getraenk.preis * menge;
                }
              }
            }
          } catch (e) {
            console.warn('Fehler beim Parsen der Getr√§nke-Daten:', e);
          }
        }

        // Essen verarbeiten
        if (gast.essen) {
          try {
            const essenData = JSON.parse(gast.essen);
            for (const [name, menge] of Object.entries(essenData)) {
              if (menge > 0) {
                const essen = essenListe.find(e => e.name === name);
                if (essen) {
                  weeklyData[weekKey].essenDetails[name] = 
                    (weeklyData[weekKey].essenDetails[name] || 0) + menge;
                  weeklyData[weekKey].essenUmsatz += essen.preis * menge;
                }
              }
            }
          } catch (e) {
            console.warn('Fehler beim Parsen der Essen-Daten:', e);
          }
        }

        // Trinkgeld
        if (gast.tip) {
          weeklyData[weekKey].trinkgeld += parseFloat(gast.tip);
        }
      });
    });

    console.log('W√∂chentliche Daten:', weeklyData);

    // Jahr-Filter bef√ºllen
    fillYearFilter(Array.from(allYears).sort((a, b) => b - a));

    // Tabelle rendern
    renderReportsTable(weeklyData);

  } catch (error) {
    console.error("Fehler beim Laden der Auswertung: ", error);
    document.getElementById('noDataMessage').classList.remove('hidden');
    document.getElementById('reportsTable').classList.add('hidden');
  }
}


// ISO Kalenderwoche berechnen
function getISOWeek(date) {
  const tempDate = new Date(date.valueOf());
  const dayNum = (date.getDay() + 6) % 7;
  tempDate.setDate(tempDate.getDate() - dayNum + 3);
  const firstThursday = tempDate.valueOf();
  tempDate.setMonth(0, 1);
  if (tempDate.getDay() !== 4) {
    tempDate.setMonth(0, 1 + ((4 - tempDate.getDay()) + 7) % 7);
  }
  return 1 + Math.ceil((firstThursday - tempDate) / 604800000);
}

// Jahre Filter bef√ºllen
function fillYearFilter(years) {
  const select = document.getElementById('filterYear');
  select.innerHTML = '<option value="">Alle Jahre</option>';
  years.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });
}

// Tabelle rendern (GEFIXT)
function renderReportsTable(weeklyData) {
  console.log('renderReportsTable aufgerufen mit:', weeklyData);
  
  const tbody = document.getElementById('auswertungTableBody');
  const noDataMsg = document.getElementById('noDataMessage');
  const table = document.getElementById('reportsTable');
  const selectedYear = document.getElementById('filterYear').value;

  // √úberpr√ºfe ob die Elemente existieren
  if (!tbody) {
    console.error('auswertungTableBody Element nicht gefunden!');
    return;
  }
  
  if (!noDataMsg) {
    console.error('noDataMessage Element nicht gefunden!');
    return;
  }
  
  if (!table) {
    console.error('reportsTable Element nicht gefunden!');
    return;
  }

  // Filtern nach Jahr wenn ausgew√§hlt
  let filteredData = weeklyData;
  if (selectedYear) {
    filteredData = {};
    for (const [key, data] of Object.entries(weeklyData)) {
      if (data.year == selectedYear) {
        filteredData[key] = data;
      }
    }
  }

  console.log('Gefilterte Daten:', filteredData);
  tbody.innerHTML = '';

  if (Object.keys(filteredData).length === 0) {
    console.log('Keine Daten vorhanden, zeige "Keine Daten" Nachricht');
    noDataMsg.classList.remove('hidden');
    table.classList.add('hidden');
    return;
  }

  console.log('Zeige Tabelle an');
  noDataMsg.classList.add('hidden');
  table.classList.remove('hidden');

  // Nach Datum sortieren (neueste zuerst)
  const sortedEntries = Object.entries(filteredData)
    .sort(([,a], [,b]) => b.sortDate - a.sortDate);

  console.log('Sortierte Eintr√§ge:', sortedEntries);

  let totalSpiele = 0;
  let totalGetraenke = 0;
  let totalEssen = 0;
  let totalTrinkgeld = 0;

  sortedEntries.forEach(([weekKey, data]) => {
    const gesamtumsatz = data.getraenkeUmsatz + data.essenUmsatz + data.trinkgeld;
    
    totalSpiele += data.spiele.length;
    totalGetraenke += data.getraenkeUmsatz;
    totalEssen += data.essenUmsatz;
    totalTrinkgeld += data.trinkgeld;

    console.log(`Erstelle Zeile f√ºr ${weekKey}:`, {
      spiele: data.spiele.length,
      getraenke: data.getraenkeUmsatz,
      essen: data.essenUmsatz,
      trinkgeld: data.trinkgeld,
      gesamt: gesamtumsatz
    });

    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    row.innerHTML = `
      <td class="p-3 border text-center font-medium">${weekKey}</td>
      <td class="p-3 border text-center">${data.spiele.length}</td>
      <td class="p-3 border text-right">${data.getraenkeUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.essenUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.trinkgeld.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right font-semibold">${gesamtumsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-center">
        <button class="text-blue-600 hover:text-blue-800 underline" onclick="showWeekDetails('${weekKey}')">
          Details
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });

  console.log('Alle Zeilen erstellt, Gesamtsummen:', {
    totalSpiele,
    totalGetraenke,
    totalEssen,
    totalTrinkgeld
  });

  // Gesamtsummen aktualisieren
  const totalSpieleEl = document.getElementById('totalSpiele');
  const totalGetraenkeEl = document.getElementById('totalGetraenke');
  const totalEssenEl = document.getElementById('totalEssen');
  const totalTrinkgeldEl = document.getElementById('totalTrinkgeld');
  const totalSummeEl = document.getElementById('totalSumme');
  
  if (totalSpieleEl) totalSpieleEl.textContent = totalSpiele;
  if (totalGetraenkeEl) totalGetraenkeEl.textContent = `${totalGetraenke.toFixed(2)} ‚Ç¨`;
  if (totalEssenEl) totalEssenEl.textContent = `${totalEssen.toFixed(2)} ‚Ç¨`;
  if (totalTrinkgeldEl) totalTrinkgeldEl.textContent = `${totalTrinkgeld.toFixed(2)} ‚Ç¨`;
  if (totalSummeEl) totalSummeEl.textContent = `${(totalGetraenke + totalEssen + totalTrinkgeld).toFixed(2)} ‚Ç¨`;

  // Daten global speichern f√ºr Details-Modal
  window.reportData = weeklyData;
  
  console.log('renderReportsTable abgeschlossen');
}

// Wochendetails anzeigen
function showWeekDetails(weekKey) {
  const data = window.reportData[weekKey];
  if (!data) return;

  document.getElementById('detailWeekTitle').textContent = weekKey;

  // Spiele
  const spieleHtml = data.spiele.map(spiel => 
    `<div class="mb-2">
      <strong>${spiel.team}</strong> vs <strong>${spiel.opponent}</strong> 
      <span class="text-gray-500 text-sm">(${formatDate(spiel.date)})</span>
    </div>`
  ).join('');
  document.getElementById('detailSpiele').innerHTML = spieleHtml || '<p class="text-gray-500">Keine Spiele</p>';

  // Getr√§nke
  const getraenkeHtml = Object.entries(data.getraenkeDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailGetraenke').innerHTML = getraenkeHtml || '<p class="text-gray-500">Keine Getr√§nke verkauft</p>';

  // Essen
  const essenHtml = Object.entries(data.essenDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailEssen').innerHTML = essenHtml || '<p class="text-gray-500">Kein Essen verkauft</p>';

  document.getElementById('modalWochendetails').classList.remove('hidden');
}

// Event Listeners
document.getElementById('filterYear').addEventListener('change', () => {
  if (window.reportData) {
    renderReportsTable(window.reportData);
  }
});

document.getElementById('btnCloseDetails').addEventListener('click', () => {
  document.getElementById('modalWochendetails').classList.add('hidden');
});

// PDF Export
document.getElementById('btnExportPDF').addEventListener('click', () => {
  if (!window.reportData) {
    showToast('Keine Daten zum Exportieren verf√ºgbar.', 'warning');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const selectedYear = document.getElementById('filterYear').value;
  const title = selectedYear ? `Auswertung ${selectedYear}` : 'Auswertung (Alle Jahre)';
  
  // Tabellendaten sammeln
  const tableData = [];
  const tbody = document.getElementById('auswertungTableBody');
  
  tbody.querySelectorAll('tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 6) {
      tableData.push([
        cells[0].textContent, // KW
        cells[1].textContent, // Spiele
        cells[2].textContent, // Getr√§nke
        cells[3].textContent, // Essen
        cells[4].textContent, // Trinkgeld
        cells[5].textContent  // Summe
      ]);
    }
  });

  // Gesamtsummen hinzuf√ºgen
  tableData.push([
    'GESAMT',
    document.getElementById('totalSpiele').textContent,
    document.getElementById('totalGetraenke').textContent,
    document.getElementById('totalEssen').textContent,
    document.getElementById('totalTrinkgeld').textContent,
    document.getElementById('totalSumme').textContent
  ]);

  doc.setFontSize(16);
  doc.text(title, 10, 15);
  doc.setFontSize(10);
  doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 10, 25);

  doc.autoTable({
    head: [['Kalenderwoche', 'Spiele', 'Getr√§nke', 'Essen', 'Trinkgeld', 'Summe']],
    body: tableData,
    startY: 35,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  const filename = selectedYear ? `auswertung-${selectedYear}.pdf` : 'auswertung-alle-jahre.pdf';
  doc.save(filename);
});

// Modal schlie√üen bei Escape oder Hintergrund-Klick
document.getElementById('modalWochendetails').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modalWochendetails')) {
    document.getElementById('modalWochendetails').classList.add('hidden');
  }
});

// Hilfsfunktion f√ºr Datumsformatierung (falls nicht bereits vorhanden)
function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split("-");
  return `${day}.${month}.${year}`;
}

// Globale Funktion f√ºr Navigation (falls nicht bereits vorhanden)
window.showWeekDetails = showWeekDetails;

// Sicherstellen, dass loadReports beim Seitenwechsel aufgerufen wird
window.loadReports = loadReports;
</script>

<script>
// Gefixte showPage Funktion
function showPage(page) {
  console.log('Zeige Seite:', page);
  
  // Alle Seiten verstecken
  const homePage = document.getElementById('page-home');
  const reportsPage = document.getElementById('page-reports');
  
  if (!homePage || !reportsPage) {
    console.error('Seitenelemente nicht gefunden!');
    return;
  }
  
  homePage.classList.add('hidden');
  reportsPage.classList.add('hidden');
  
  // Aktuelle Seite anzeigen
  const currentPage = document.getElementById('page-' + page);
  if (currentPage) {
	console.log('Entferne hidden von:', currentPage.id);
    currentPage.classList.remove('hidden');
  } else {
    console.error(`Seite page-${page} nicht gefunden!`);
    return;
  }
  
  // Alle Buttons auf inaktiv setzen (hellgrau)
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('bg-gray-400');
    btn.classList.add('bg-gray-300');
  });
  
  // Nur den aktiven Button hervorheben (dunkelgrau)
  const activeBtn = document.getElementById('btn-' + page);
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-300');
    activeBtn.classList.add('bg-gray-400');
  }
  
  // Berichte laden, wenn reports aktiv ist
  if (page === 'reports') {
    console.log('Wechsle zu Reports-Seite, lade Daten...');
    
    // √úberpr√ºfe ob die Tabellen-Elemente existieren bevor loadReports aufgerufen wird
    setTimeout(() => {
      console.log('Pr√ºfe Tabellen-Elemente...');
      checkElements();
      
      // Warte zus√§tzlich auf Firebase
      if (window.firebaseReady) {
        console.log('Firebase bereit, rufe loadReports auf');
        loadReports();
      } else {
        console.log('Warte auf Firebase...');
        window.addEventListener('firebaseReady', () => {
          console.log('Firebase Ready Event empfangen, rufe loadReports auf');
          loadReports();
        }, { once: true });
        
        // Fallback nach 3 Sekunden
        setTimeout(() => {
          console.log('Fallback: rufe loadReports nach 3s auf');
          loadReports();
        }, 3000);
      }
    }, 200);
  }
}

// Debug-Funktion um zu pr√ºfen ob alle Elemente existieren
function checkElements() {
  const elements = [
    'auswertungTableBody',
    'noDataMessage', 
    'reportsTable',
    'filterYear',
    'totalSpiele',
    'totalGetraenke',
    'totalEssen',
    'totalTrinkgeld',
    'totalSumme'
  ];
  
  elements.forEach(id => {
    const el = document.getElementById(id);
    console.log(`Element ${id}:`, el ? '‚úì gefunden' : '‚úó NICHT gefunden');
  });
}

// Aufruf der Debug-Funktion beim Seitenwechsel
window.checkElements = checkElements;


// Erweiterte Debug-Funktion - f√ºge das zum bestehenden Script hinzu
function debugFullReports() {
  console.log('=== VOLLST√ÑNDIGER REPORTS DEBUG ===');
  
  // 1. Pr√ºfe DOM-Elemente
  console.log('1. DOM-Elemente Check:');
  checkElements();
  
  // 2. Pr√ºfe Firebase Status  
  console.log('2. Firebase Status:');
  console.log('Firebase Ready:', window.firebaseReady);
  console.log('Firebase DB:', window.firebaseDB);
  console.log('Firebase Utils:', window.firebaseUtils);
  
  // 3. Pr√ºfe aktuelle Seite
  console.log('3. Aktuelle Seite:');
  const reportsPage = document.getElementById('page-reports');
  console.log('Reports Page Element:', reportsPage);
  console.log('Reports Page Hidden:', reportsPage ? reportsPage.classList.contains('hidden') : 'Element nicht gefunden');
  
  // 4. Manueller loadReports Test
  console.log('4. Manueller loadReports Test:');
  if (window.firebaseReady && window.firebaseDB) {
    console.log('Firebase verf√ºgbar, teste loadReports...');
    loadReports().then(() => {
      console.log('loadReports abgeschlossen');
    }).catch(error => {
      console.error('loadReports Fehler:', error);
    });
  } else {
    console.log('Firebase nicht verf√ºgbar f√ºr Test');
  }
  
  // 5. Pr√ºfe vorhandene Daten
  console.log('5. Gespeicherte Spiele Check:');
  console.log('Anzahl gespeicherter Spiele:', gespeicherteSpiele ? gespeicherteSpiele.length : 'Undefined');
  if (gespeicherteSpiele && gespeicherteSpiele.length > 0) {
    console.log('Beispielspiel:', gespeicherteSpiele[0]);
  }
}

// Global verf√ºgbar machen
window.debugFullReports = debugFullReports;



// Debug-Funktion f√ºr manuelle Auswertung
window.debugReports = function() {
  console.log('=== MANUAL DEBUG START ===');
  console.log('Firebase DB:', window.firebaseDB);
  console.log('Firebase Utils:', window.firebaseUtils);
  console.log('Firebase Ready:', window.firebaseReady);
  
  if (!window.firebaseDB) {
    console.error('Firebase nicht initialisiert!');
    return;
  }
  
  // Teste Firebase-Abfrage direkt
  window.firebaseUtils.getDocs(
    window.firebaseUtils.collection(window.firebaseDB, "spiele")
  ).then(snapshot => {
    console.log('Firebase Snapshot Size:', snapshot.size);
    console.log('Firebase Snapshot Empty:', snapshot.empty);
    
    const allGames = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      allGames.push(data);
      console.log('Spiel Daten:', {
        id: doc.id,
        team: data.team,
        opponent: data.opponent, 
        date: data.date,
        gaeste: data.gaeste,
        gaesteCount: data.gaeste ? data.gaeste.length : 0
      });
    });
    
    console.log('Alle Spiele:', allGames);
    
    // Teste ob Spiele G√§ste haben
    const spieleMitGaesten = allGames.filter(spiel => 
      spiel.gaeste && spiel.gaeste.length > 0
    );
    console.log('Spiele mit G√§sten:', spieleMitGaesten.length);
    
    // Teste ob G√§ste Getr√§nke/Essen haben
    spieleMitGaesten.forEach((spiel, index) => {
      console.log(`=== Spiel ${index + 1}: ${spiel.team} vs ${spiel.opponent} ===`);
      spiel.gaeste.forEach((gast, gastIndex) => {
        console.log(`Gast ${gastIndex + 1}:`, {
          name: gast.name,
          getraenke: gast.getraenke,
          essen: gast.essen,
          tip: gast.tip,
          paid: gast.paid
        });
        
        if (gast.getraenke) {
          try {
            const getraenkeData = JSON.parse(gast.getraenke);
            console.log('Geparste Getr√§nke:', getraenkeData);
          } catch (e) {
            console.error('Fehler beim Parsen der Getr√§nke:', e);
          }
        }
        
        if (gast.essen) {
          try {
            const essenData = JSON.parse(gast.essen);
            console.log('Geparste Essen:', essenData);
          } catch (e) {
            console.error('Fehler beim Parsen des Essens:', e);
          }
        }
		if (gast.tip) {
      weeklyData[weekKey].trinkgeld += parseFloat(gast.tip);
    }
      });
    });
    
  }).catch(error => {
    console.error('Firebase Fehler:', error);
  });
};
</script>

<!-- Modal: Best√§tigung -->
<div id="modalConfirm" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Best√§tigung erforderlich</h2>
    <p id="confirmMessage" class="mb-6 text-gray-700"></p>
    <div class="flex justify-end space-x-2">
      <button id="btnConfirmCancel" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Abbrechen</button>
      <button id="btnConfirmOk" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">L√∂schen</button>
    </div>
  </div>
</div>
</div> <!-- Ende mainApp -->

<script>
// Login-Funktionalit√§t
let isLoggedIn = false;
let currentUser = null;

// Benutzer authentifizieren
async function authenticateUser(email, password) {
      try {
        if (!window.firebaseAuth) {
          console.error('Firebase Auth nicht initialisiert');
          return false;
        }

        const userCredential = await window.authUtils.signInWithEmailAndPassword(
          window.firebaseAuth, 
          email, 
          password
        );
        
        console.log('Benutzer erfolgreich angemeldet:', userCredential.user);
        return userCredential.user;
      } catch (error) {
        console.error("Fehler bei der Authentifizierung: ", error);
        
        // Benutzerfreundliche Fehlermeldungen
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          throw new Error('Ung√ºltige E-Mail oder Passwort');
        } else if (error.code === 'auth/invalid-email') {
          throw new Error('Ung√ºltige E-Mail-Adresse');
        } else {
          throw new Error('Anmeldung fehlgeschlagen. Bitte versuchen Sie es erneut.');
        }
      }
    }
	
	// Benutzer erstellen (f√ºr Setup)
    async function createUser(email, password) {
      try {
        if (!window.firebaseAuth) {
          console.error('Firebase Auth nicht initialisiert');
          return false;
        }

        const userCredential = await window.authUtils.createUserWithEmailAndPassword(
          window.firebaseAuth, 
          email, 
          password
        );
        
        // Zus√§tzlich Benutzer-Dokument in Firestore erstellen
        const userData = {
          email: email,
          isActive: true,
          createdAt: new Date().toISOString(),
          role: 'admin'
        };

        await window.firebaseUtils.addDoc(
          window.firebaseUtils.collection(window.firebaseDB, "users"), 
          { ...userData, uid: userCredential.user.uid }
        );

        console.log("Admin-Benutzer erstellt:", userCredential.user);
        return userCredential.user;
      } catch (error) {
        console.error("Fehler beim Erstellen des Benutzers: ", error);
        
        if (error.code === 'auth/email-already-in-use') {
          throw new Error('Diese E-Mail-Adresse wird bereits verwendet');
        } else if (error.code === 'auth/weak-password') {
          throw new Error('Das Passwort ist zu schwach');
        } else {
          throw new Error('Account-Erstellung fehlgeschlagen');
        }
      }
    }

    // Logout-Funktion
    async function logout() {
      try {
        await window.authUtils.signOut(window.firebaseAuth);
        showToast('Erfolgreich abgemeldet.');
      } catch (error) {
        console.error('Logout-Fehler:', error);
        showToast('Fehler beim Abmelden.', 'error');
      }
    }

// Login-Event
document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginButton = document.getElementById('loginButton');
      const loginError = document.getElementById('loginError');
      
      if (!email || !password) {
        loginError.textContent = 'Bitte f√ºllen Sie alle Felder aus.';
        loginError.classList.remove('hidden');
        return;
      }
  
  // Button deaktivieren w√§hrend Login
  loginButton.disabled = true;
  loginButton.textContent = 'Anmelden...';
  loginError.classList.add('hidden');
  
  try {
    // Warten bis Firebase bereit ist
    if (!window.firebaseReady) {
      await new Promise(resolve => {
        if (window.firebaseReady) {
          resolve();
        } else {
          window.addEventListener('firebaseReady', resolve, { once: true });
          setTimeout(resolve, 3000); // Fallback timeout
        }
      });
    }
    
    const user = await authenticateUser(email, password);
    
    if (user) {
      // Erfolgreicher Login
      isLoggedIn = true;
      currentUser = user;
      
      // Session speichern (optional)
      sessionStorage.setItem('isLoggedIn', 'true');
      sessionStorage.setItem('currentUser', JSON.stringify(user));
      
      // UI wechseln
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      // Bestehende Daten laden
      await loadGamesFromFirebase();
      
      showToast('Erfolgreich angemeldet!');
    } else {
      // Login fehlgeschlagen
      loginError.textContent = 'Ung√ºltige E-Mail oder Passwort.';
      loginError.classList.remove('hidden');
    }
  } catch (error) {
    console.error('Login-Fehler:', error);
    loginError.textContent = 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.';
    loginError.classList.remove('hidden');
  } finally {
    // Button wieder aktivieren
    loginButton.disabled = false;
    loginButton.textContent = 'Anmelden';
  }
});

// Session-Check beim Laden der Seite
function checkExistingSession() {
  const savedLogin = sessionStorage.getItem('isLoggedIn');
  const savedUser = sessionStorage.getItem('currentUser');
  
  if (savedLogin === 'true' && savedUser) {
    isLoggedIn = true;
    currentUser = JSON.parse(savedUser);
    
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Bestehende Daten laden
    if (window.firebaseReady) {
      loadGamesFromFirebase();
    }
  }
}

// Logout-Funktion
function logout() {
  isLoggedIn = false;
  currentUser = null;
  
  sessionStorage.removeItem('isLoggedIn');
  sessionStorage.removeItem('currentUser');
  
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
  
  // Login-Form zur√ºcksetzen
  document.getElementById('loginForm').reset();
  document.getElementById('loginError').classList.add('hidden');
  
  showToast('Erfolgreich abgemeldet.');
}

// Global verf√ºgbare Funktionen
window.logout = logout;

// Session-Check beim Laden der Seite
window.addEventListener('load', () => {
  checkExistingSession();
  
});
</script>

</body>
</html>