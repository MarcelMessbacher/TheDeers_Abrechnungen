<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heimspielabrechnung The Deers</title>
  <link rel="icon" type="image/svg" href="The Deers Logo nur Hirsch.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF-AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase v10 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyD5B4C8EiEdLA2XWLzb2JvcFi9DAnV1M7E",
      authDomain: "thedeersabrechnung.firebaseapp.com",
      projectId: "thedeersabrechnung",
      storageBucket: "thedeersabrechnung.firebasestorage.app",
      messagingSenderId: "27261468983",
      appId: "1:27261468983:web:1a6340756263aad9455ab2",
      measurementId: "G-6KBNXWTYJ1"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Firebase Funktionen global verf√ºgbar machen
    window.firebaseDB = db;
    window.firebaseUtils = { collection, addDoc, getDocs, updateDoc, doc, deleteDoc };
    window.firebaseReady = true;
    
    // Event f√ºr Firebase-Initialisierung
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  <style>
    .modal-game-background {
      background-image: url('The Deers Logo dunkelgrau-hellgrau.svg');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: contain;
      background-attachment: fixed;
      position: relative;
    }
    
    .modal-game-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      z-index: 1;
    }
    
    .modal-game-content {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

<!-- Kopfbereich mit Logo + Titel -->
<div class="relative mb-8">
  <div class="absolute top-0 right-5">
    <img src="The Deers Logo A4.svg" alt="Logo" class="h-44 w-auto">
  </div>
  <div class="text-center">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Heimspielabrechnung The Deers</h1>
    <h2 class="text-3xl text-gray-600">TSV Hirschaid</h2>
  </div>
</div>

  <nav class="mb-6" align="center">
  <button id="btn-home" onclick="showPage('home')" class="nav-btn bg-gray-400 text-white px-4 py-2 rounded mb-4 hover:bg-gray-400 font-bold" style="width: 150px;">Heimspiele</button>
  <button id="btn-reports" onclick="showPage('reports')" class="nav-btn bg-gray-300 text-white px-4 py-2 rounded mb-4 hover:bg-gray-400 font-bold" style="width: 150px;">Auswertungen</button>
</nav>

<div id="page-home">
  <!-- Button: Neues Heimspiel -->
  <button id="btnNewGame" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">Neues Heimspiel</button>

  <!-- Container f√ºr gespeicherte Formulare -->
  <div id="gamesContainer"></div>

  <!-- Modal: Spiel -->
  <div id="modalGame" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto modal-game-background">
     <div class="modal-game-content"> 
	  <h2 class="text-xl font-bold mb-4">Spiel</h2>

      <div class="flex space-x-4 mb-4">
        <!-- Dropdown Team -->
        <div>
          <label class="block text-sm font-medium mb-1">Team</label>
          <select id="selectTeam" class="border rounded w-40 p-2">
            <option value="">Bitte w√§hlen</option>
            <option value="TheDeers I">TheDeers I</option>
            <option value="TheDeers II">TheDeers II</option>
            <option value="TheDeers III">TheDeers III</option>
            <option value="TheDeers IV">TheDeers IV</option>
          </select>
        </div>

        <!-- Gegner -->
        <div>
          <label class="block text-sm font-medium mb-1">Gegner</label>
          <input type="text" id="inputOpponent" class="border rounded w-40 p-2" />
        </div>

        <!-- Datum -->
        <div>
          <label class="block text-sm font-medium mb-1">Datum</label>
          <input type="date" id="inputDate" class="border rounded w-40 p-2" />
        </div>
      </div>

      <!-- Tabelle G√§ste -->
      <table class="w-full text-sm mb-4" id="tab_Gaeste">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Getr√§nke</th>
            <th class="p-2 border">Essen</th>
            <th class="p-2 border">Gesamtbetrag</th>
            <th class="p-2 border">Abrechnung</th>
            <th class="p-2 border">Aktion</th>
          </tr>
        </thead>
        <tbody>
          <!-- Zeilen werden dynamisch hinzugef√ºgt -->
        </tbody>
      </table>
      <button id="addGuestRow" class="text-blue-600 mb-4 hover:text-blue-800">+ Gast hinzuf√ºgen</button>

      <!-- Spiel abrechnen, Speichern & Schlie√üen -->
      <div class="flex justify-end space-x-2">
        <button id="btnFinalizeGame" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded" disabled>Spiel abrechnen</button>
        <button id="btnSaveGame" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGame" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>

    </div>
  </div>

  <!-- Modal: Getr√§nke -->
  <div id="modalGetraenke" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Getr√§nke</h2>
      <table class="w-full text-sm mb-4" id="tab_Getraenke">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Name</th>
            <th class="p-2 border">Preis</th>
            <th class="p-2 border">Anzahl</th>
            <th class="p-2 border">Zwischensumme</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dynamisch bef√ºllt -->
        </tbody>
      </table>
      <div class="mb-4 font-semibold">Summe Getr√§nke: <span id="summe_Getraenke">0.00</span> ‚Ç¨</div>
      <div class="flex justify-end space-x-2">
        <button id="btnSaveGetraenke" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        <button id="btnCloseGetraenke" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Essen -->
  <div id="modalEssen" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Essen ausw√§hlen</h2>
      <table class="min-w-full border mb-4">
        <thead>
          <tr>
            <th class="border p-2">Name</th>
            <th class="border p-2">Preis (‚Ç¨)</th>
            <th class="border p-2">Anzahl</th>
            <th class="border p-2">Zwischensumme (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody id="tab_Essen">
          <!-- Dynamisch per JS bef√ºllt -->
        </tbody>
      </table>
      <div class="mb-4 font-semibold">
        <strong>Gesamtsumme Essen:</strong> <span id="summe_Essen">0.00</span> ‚Ç¨
      </div>
      <button id="btnSaveEssen" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Speichern</button>
      <button id="btnCloseEssen" class="bg-gray-500 text-white px-4 py-2 rounded ml-2 hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>

  <!-- Modal: Abrechnung -->
  <div id="modalAbrechnung" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Abrechnung</h2>
      <div id="abrechnungContent"></div>
      <div class="my-4">
        <label class="block text-sm font-medium mb-1">Trinkgeld (‚Ç¨)</label>
        <input type="number" id="inputTip" class="border rounded w-full p-2" step="0.01" min="0" />
      </div>
      <div class="flex justify-end space-x-2">
        <button id="btnPaid" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Bezahlt</button>
        <button id="btnCloseAbrechnung" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
      </div>
    </div>
  </div>
</div>

<!-- Seite 2: Auswertungen -->
<div id="page-reports" class="hidden">
  <h1 class="text-3xl font-bold mb-6">Auswertungen</h1>
  
  <!-- Filter-Bereich -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="flex items-center space-x-4">
      <div>
        <label class="block text-sm font-medium mb-1">Jahr filtern</label>
        <select id="filterYear" class="border rounded p-2">
          <option value="">Alle Jahre</option>
        </select>
      </div>
      <div>
        <button id="btnExportPDF" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Als PDF exportieren</button>
      </div>
    </div>
  </div>

  <!-- Auswertungstabelle -->
  <div class="bg-white shadow rounded overflow-hidden">
    <table id="reportsTable" class="min-w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-3 border font-semibold">Kalenderwoche</th>
          <th class="p-3 border font-semibold">Spiele</th>
          <th class="p-3 border font-semibold">Getr√§nke (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Essen (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Trinkgeld (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Summe (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Details</th>
        </tr>
      </thead>
      <tbody id="auswertungTableBody">
        <!-- Wird dynamisch bef√ºllt -->
      </tbody>
      <tfoot class="bg-gray-100">
        <tr class="font-bold">
          <td class="p-3 border">GESAMT</td>
          <td class="p-3 border text-center" id="totalSpiele">0</td>
          <td class="p-3 border text-right" id="totalGetraenke">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalEssen">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalTrinkgeld">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalSumme">0.00 ‚Ç¨</td>
          <td class="p-3 border"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Leer-Zustand -->
  <div id="noDataMessage" class="text-center py-8 text-gray-500 hidden">
    <p>Keine Daten f√ºr die Auswertung verf√ºgbar.</p>
    <p class="text-sm mt-2">F√ºgen Sie erst Spiele mit G√§sten hinzu, damit hier Auswertungen angezeigt werden.</p>
  </div>
</div>

<!-- Modal: Wochendetails -->
<div id="modalWochendetails" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">Details f√ºr <span id="detailWeekTitle"></span></h2>
    
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Spiele in dieser Woche:</h3>
      <div id="detailSpiele" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkaufte Getr√§nke:</h3>
      <div id="detailGetraenke" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkauftes Essen:</h3>
      <div id="detailEssen" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="flex justify-end">
      <button id="btnCloseDetails" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>
</div>

<script>

let gespeicherteSpiele = [];
let editIndex = null;
let aktuelleGetraenkeRow = null;
let aktuelleEssenRow = null;
let aktuelleAbrechnungRow = null;

// Getr√§nke und Essen Daten
const getraenkeListe = [
  { name: 'Softdrink/Wasser', preis: 2.50 },
  { name: 'Bier des Monats', preis: 3.50 },
  { name: 'Krausenbier', preis: 3.00 },
  { name: 'Weizen', preis: 3.50 },
  { name: 'Winzerschorle', preis: 4.50 },
  { name: 'Kaffee/Tee', preis: 1.50 },
  { name: 'Cola', preis: 2.50 }
];

const essenListe = [
  { name: 'Pizza', preis: 9.00 },
  { name: 'Chicken Nuggets', preis: 5.00 },
  { name: 'Chilli Cheese Nuggets', preis: 5.00 },
  { name: 'Riegel', preis: 1.00 }
];

// Hilfsfunktion zum Runden auf 2 Nachkommastellen
function round2(num) {
  return Math.round(num * 100) / 100;
}

// Hilfsfunktion f√ºr Datumsformatierung
function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split("-");
  return `${day}.${month}.${year}`;
}

// Firebase Funktionen
async function saveGameToFirebase(spielData) {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return null;
    }
    
    const docRef = await window.firebaseUtils.addDoc(
      window.firebaseUtils.collection(window.firebaseDB, "spiele"), 
      {
        ...spielData,
        timestamp: new Date().toISOString()
      }
    );
    console.log("Spiel in Firebase gespeichert mit ID: ", docRef.id);
    return docRef.id;
  } catch (error) {
    console.error("Fehler beim Speichern in Firebase: ", error);
    return null;
  }
}

async function updateGameInFirebase(gameId, spielData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      ...spielData,
      lastUpdated: new Date().toISOString()
    });
    console.log("Spiel in Firebase aktualisiert:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Aktualisieren in Firebase: ", error);
    return false;
  }
}

async function deleteGameFromFirebase(gameId) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.deleteDoc(gameRef);
    console.log("Spiel aus Firebase gel√∂scht:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim L√∂schen aus Firebase: ", error);
    return false;
  }
}

async function loadGamesFromFirebase() {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return;
    }
    
    const querySnapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );
    
    gespeicherteSpiele = [];
    querySnapshot.forEach((doc) => {
      gespeicherteSpiele.push({
        id: doc.id,
        firebaseId: doc.id,
        ...doc.data()
      });
    });
    
    renderGames();
  } catch (error) {
    console.error("Fehler beim Laden aus Firebase: ", error);
  }
}

// PDF in Firebase speichern
async function savePDFToFirebase(gameId, pdfData) {
  try {
    if (!window.firebaseDB || !gameId) {
      console.warn('Firebase nicht initialisiert oder keine Game-ID');
      return false;
    }
    
    const gameRef = window.firebaseUtils.doc(window.firebaseDB, "spiele", gameId);
    await window.firebaseUtils.updateDoc(gameRef, {
      pdfData: pdfData,
      pdfCreatedAt: new Date().toISOString()
    });
    console.log("PDF in Firebase gespeichert f√ºr Spiel:", gameId);
    return true;
  } catch (error) {
    console.error("Fehler beim Speichern des PDFs in Firebase: ", error);
    return false;
  }
}

// Event Listeners
document.getElementById('btnNewGame').addEventListener('click', () => {
  editIndex = null;
  clearGameForm();
  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
  document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  initializeGaesteTable();
});

document.getElementById('btnCloseGame').addEventListener('click', () => {
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
});

document.getElementById('btnCloseGetraenke').addEventListener('click', () => {
  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

document.getElementById('btnCloseEssen').addEventListener('click', () => {
  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

document.getElementById('btnCloseAbrechnung').addEventListener('click', () => {
  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
});

document.getElementById('addGuestRow').addEventListener('click', addGuestRow);

// Form zur√ºcksetzen
function clearGameForm() {
  document.getElementById('selectTeam').value = '';
  document.getElementById('inputOpponent').value = '';
  document.getElementById('inputDate').value = '';
  document.querySelector('#tab_Gaeste tbody').innerHTML = '';
}

function initializeGaesteTable() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  for (let i = 0; i < 4; i++) addGuestRow();
}

function addGuestRow() {
  const tbody = document.querySelector('#tab_Gaeste tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td class="border p-2">
      <input type="text" class="border rounded w-full p-1" placeholder="Name" />
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddGetraenke hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2">
      <button class="bg-blue-500 text-white px-2 py-1 rounded btnAddEssen hover:bg-blue-600">+ Hinzuf√ºgen</button>
    </td>
    <td class="border p-2 summeGesamt text-right">0.00 ‚Ç¨</td>
    <td class="border p-2">
      <button class="bg-gray-500 text-white px-2 py-1 rounded btnAbrechnen hover:bg-gray-600">Abrechnen</button>
    </td>
    <td class="border p-2 text-center">
      <button class="bg-red-600 text-white px-2 py-1 rounded btnDeleteGuest hover:bg-red-700">X</button>
    </td>
  `;
  tbody.appendChild(row);

  // Event-Listener f√ºr Buttons in der neuen Zeile
  row.querySelector('.btnAddGetraenke').addEventListener('click', () => openGetraenkeModal(row));
  row.querySelector('.btnAddEssen').addEventListener('click', () => openEssenModal(row));
  row.querySelector('.btnAbrechnen').addEventListener('click', () => openAbrechnungModal(row));
  row.querySelector('.btnDeleteGuest').addEventListener('click', () => {
    row.remove();
    updateFinalizeButtonState();
  });
}

// Getr√§nke Modal √∂ffnen
function openGetraenkeModal(row) {
  aktuelleGetraenkeRow = row;
  const tbody = document.querySelector('#tab_Getraenke tbody');
  tbody.innerHTML = '';

  // Lade bereits vorhandene Getr√§nke aus Daten-Attribut
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  let getraenkeData = gespeicherteGetraenke ? JSON.parse(gespeicherteGetraenke) : {};

  getraenkeListe.forEach((getraenk) => {
    const menge = getraenkeData[getraenk.name] || 0;
    const zwischensumme = round2(getraenk.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2 border">${getraenk.name}</td>
      <td class="p-2 border text-right">${getraenk.preis.toFixed(2)} ‚Ç¨</td>
      <td class="p-2 border text-center">
        <input type="number" min="0" value="${menge}" class="inputAnzahl border rounded w-16 text-center p-1" data-preis="${getraenk.preis}" />
      </td>
      <td class="p-2 border zwischensumme text-right">${zwischensumme} ‚Ç¨</td>
    `;
    tbody.appendChild(tr);

    // Event f√ºr Eingabe √Ñnderung
    tr.querySelector('.inputAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum + ' ‚Ç¨';
      updateGetraenkeSumme();
    });
  });

  updateGetraenkeSumme();
  document.getElementById('modalGetraenke').classList.remove('hidden');
}

function updateGetraenkeSumme() {
  const tbody = document.querySelector('#tab_Getraenke tbody');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent.replace(' ‚Ç¨', '');
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Getraenke').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveGetraenke').addEventListener('click', () => {
  if (!aktuelleGetraenkeRow) return;

  const tbody = document.querySelector('#tab_Getraenke tbody');
  const getraenkeData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputAnzahl').value) || 0;
    if (menge > 0) {
      getraenkeData[name] = menge;
    }
  });

  aktuelleGetraenkeRow.setAttribute('data-getraenke', JSON.stringify(getraenkeData));
  updateGesamtbetrag(aktuelleGetraenkeRow);

  document.getElementById('modalGetraenke').classList.add('hidden');
  aktuelleGetraenkeRow = null;
});

// Essen Modal √∂ffnen
function openEssenModal(row) {
  aktuelleEssenRow = row;
  const tbody = document.getElementById('tab_Essen');
  tbody.innerHTML = '';

  // Lade gespeicherte Essen-Daten
  let gespeicherteEssen = row.getAttribute('data-essen');
  let essenData = gespeicherteEssen ? JSON.parse(gespeicherteEssen) : {};

  essenListe.forEach(item => {
    const menge = essenData[item.name] || 0;
    const zwischensumme = round2(item.preis * menge).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-2 py-1">${item.name}</td>
      <td class="border px-2 py-1 text-right">${item.preis.toFixed(2)}</td>
      <td class="border px-2 py-1 text-center">
        <input type="number" min="0" value="${menge}" class="inputEssenAnzahl border rounded w-16 text-center p-1" data-preis="${item.preis}" />
      </td>
      <td class="border px-2 py-1 text-right zwischensumme">${zwischensumme}</td>
    `;
    tbody.appendChild(tr);

    tr.querySelector('.inputEssenAnzahl').addEventListener('input', (e) => {
      const wert = parseInt(e.target.value) || 0;
      const preis = parseFloat(e.target.getAttribute('data-preis'));
      const sum = round2(preis * wert).toFixed(2);
      tr.querySelector('.zwischensumme').textContent = sum;
      updateEssenSumme();
    });
  });

  updateEssenSumme();
  document.getElementById('modalEssen').classList.remove('hidden');
}

function updateEssenSumme() {
  const tbody = document.getElementById('tab_Essen');
  let sum = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const text = tr.querySelector('.zwischensumme').textContent;
    sum += parseFloat(text) || 0;
  });
  document.getElementById('summe_Essen').textContent = sum.toFixed(2);
}

document.getElementById('btnSaveEssen').addEventListener('click', () => {
  if (!aktuelleEssenRow) return;

  const tbody = document.getElementById('tab_Essen');
  const essenData = {};
  tbody.querySelectorAll('tr').forEach(tr => {
    const name = tr.children[0].textContent;
    const menge = parseInt(tr.querySelector('.inputEssenAnzahl').value) || 0;
    if (menge > 0) {
      essenData[name] = menge;
    }
  });

  aktuelleEssenRow.setAttribute('data-essen', JSON.stringify(essenData));
  updateGesamtbetrag(aktuelleEssenRow);

  document.getElementById('modalEssen').classList.add('hidden');
  aktuelleEssenRow = null;
});

// Berechnung und Aktualisierung des Gesamtbetrags je Gast
function updateGesamtbetrag(row) {
  let sumGetraenke = 0;
  let sumEssen = 0;

  // Getr√§nke summieren
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    for (const name in getraenkeData) {
      const menge = getraenkeData[name];
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        sumGetraenke += getraenk.preis * menge;
      }
    }
  }

  // Essen summieren
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    for (const name in essenData) {
      const menge = essenData[name];
      const essen = essenListe.find(e => e.name === name);
      if (essen) {
        sumEssen += essen.preis * menge;
      }
    }
  }

  const summeGesamt = round2(sumGetraenke + sumEssen);
  row.querySelector('.summeGesamt').textContent = summeGesamt.toFixed(2) + ' ‚Ç¨';
}

// Abrechnung Modal √∂ffnen
function openAbrechnungModal(row) {
  aktuelleAbrechnungRow = row;
  const abrechnung = document.getElementById('abrechnungContent');
  const name = row.querySelector('input[type="text"]').value || '(unbekannt)';
  const summeText = row.querySelector('.summeGesamt').textContent || '0.00 ‚Ç¨';

  // Getr√§nke laden
  let getraenkeHtml = '<h3 class="font-semibold mt-2">Getr√§nke:</h3>';
  let gespeicherteGetraenke = row.getAttribute('data-getraenke');
  if (gespeicherteGetraenke) {
    const getraenkeData = JSON.parse(gespeicherteGetraenke);
    if (Object.keys(getraenkeData).length === 0) {
      getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
    } else {
      getraenkeHtml += '<ul class="list-disc ml-5">';
      for (const nameGetr in getraenkeData) {
        const menge = getraenkeData[nameGetr];
        const getraenk = getraenkeListe.find(g => g.name === nameGetr);
        const preis = getraenk ? getraenk.preis : 0;
        getraenkeHtml += `<li>${nameGetr}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      getraenkeHtml += '</ul>';
    }
  } else {
    getraenkeHtml += '<p class="text-gray-500">Keine Getr√§nke gew√§hlt.</p>';
  }

  // Essen laden
  let essenHtml = '<h3 class="font-semibold mt-2">Essen:</h3>';
  let gespeicherteEssen = row.getAttribute('data-essen');
  if (gespeicherteEssen) {
    const essenData = JSON.parse(gespeicherteEssen);
    if (Object.keys(essenData).length === 0) {
      essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
    } else {
      essenHtml += '<ul class="list-disc ml-5">';
      for (const nameEssen in essenData) {
        const menge = essenData[nameEssen];
        const essen = essenListe.find(e => e.name === nameEssen);
        const preis = essen ? essen.preis : 0;
        essenHtml += `<li>${nameEssen}: ${menge} √ó ${preis.toFixed(2)} ‚Ç¨ = ${(menge * preis).toFixed(2)} ‚Ç¨</li>`;
      }
      essenHtml += '</ul>';
    }
  } else {
    essenHtml += '<p class="text-gray-500">Kein Essen gew√§hlt.</p>';
  }

  abrechnung.innerHTML = `
    <div class="bg-gray-50 p-3 rounded">
      <p><strong>Gast:</strong> ${name}</p>
      <p><strong>Gesamtbetrag:</strong> ${summeText}</p>
      ${getraenkeHtml}
      ${essenHtml}
    </div>
  `;

  document.getElementById('inputTip').value = '';
  document.getElementById('modalAbrechnung').classList.remove('hidden');
}

// Event-Listener f√ºr ‚ÄûBezahlt"-Button
document.getElementById('btnPaid').addEventListener('click', () => {
  if (!aktuelleAbrechnungRow) return;

  const tipAmount = parseFloat(document.getElementById('inputTip').value) || 0;
  aktuelleAbrechnungRow.setAttribute('data-tip', tipAmount.toFixed(2));

  // 1. Markiere als abgerechnet
  aktuelleAbrechnungRow.classList.add('bg-green-100');
  aktuelleAbrechnungRow.setAttribute('data-paid', 'true');

  // 2. Name-Feld deaktivieren
  const nameInput = aktuelleAbrechnungRow.querySelector('input[type="text"]');
  if (nameInput) {
    nameInput.setAttribute('disabled', 'true');
    nameInput.classList.add('bg-gray-200');
  }

  // 3. Getr√§nke Button deaktivieren
  const btnGetraenke = aktuelleAbrechnungRow.querySelector('.btnAddGetraenke');
  if (btnGetraenke) {
    btnGetraenke.setAttribute('disabled', 'true');
    btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 4. Essen Button deaktivieren
  const btnEssen = aktuelleAbrechnungRow.querySelector('.btnAddEssen');
  if (btnEssen) {
    btnEssen.setAttribute('disabled', 'true');
    btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 5. Abrechnen Button deaktivieren
  const btnAbrechnen = aktuelleAbrechnungRow.querySelector('.btnAbrechnen');
  if (btnAbrechnen) {
    btnAbrechnen.setAttribute('disabled', 'true');
    btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
    btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
  }

  // 6. L√∂schbutton durch gr√ºnen Haken ersetzen
  const lastTd = aktuelleAbrechnungRow.querySelectorAll('td')[5];
  if (lastTd) {
    lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
  }

  document.getElementById('modalAbrechnung').classList.add('hidden');
  aktuelleAbrechnungRow = null;
  updateFinalizeButtonState();
});

function updateFinalizeButtonState() {
  const rows = document.querySelectorAll('#tab_Gaeste tbody tr');
  if (rows.length === 0) return;

  // Pr√ºfe ob alle G√§ste mit Namen auch bezahlt haben
  const gaesteWithNames = Array.from(rows).filter(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    return name !== '';
  });

  const allPaid = gaesteWithNames.length > 0 && gaesteWithNames.every(row => row.getAttribute('data-paid') === 'true');

  const btn = document.getElementById('btnFinalizeGame');
  if (!btn) return;

  if (allPaid) {
    btn.disabled = false;
    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
  } else {
    btn.disabled = true;
    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
  }
}

// Speichern des gesamten Spiels
document.getElementById('btnSaveGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
    alert('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).');
    return;
  }

  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) { // Nur G√§ste mit Namen speichern
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  // Status bestimmen: ready wenn alle G√§ste bezahlt haben, sonst draft
  const allPaid = gaeste.length > 0 && gaeste.every(gast => gast.paid);
  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: allPaid ? 'ready' : 'draft' 
  };

  if (editIndex !== null) {
    // Update bestehendes Spiel
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId; // Firebase-ID beibehalten
    gespeicherteSpiele[editIndex] = spielData;
    
    // In Firebase aktualisieren
    if (spielData.firebaseId) {
      await updateGameInFirebase(spielData.firebaseId, spielData);
    }
    
    editIndex = null;
  } else {
    // Neues Spiel speichern
    const firebaseId = await saveGameToFirebase(spielData);
    if (firebaseId) {
      spielData.firebaseId = firebaseId;
    }
    gespeicherteSpiele.push(spielData);
  }

  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  // Erfolgs-Nachricht
  const statusText = spielData.status === 'ready' ? 'bereit f√ºr Abrechnung' : 'als Entwurf gespeichert';
  alert(`Spiel wurde ${statusText}!`);
});

// PDF-Erstellung f√ºr Spiel-Abrechnung (Final-Abrechnung)
document.getElementById('btnFinalizeGame').addEventListener('click', async () => {
  const team = document.getElementById('selectTeam').value;
  const opponent = document.getElementById('inputOpponent').value;
  const date = document.getElementById('inputDate').value;

  if (!team || !opponent || !date) {
    alert('Bitte f√ºllen Sie alle Pflichtfelder aus (Team, Gegner, Datum).');
    return;
  }

  // Erst das Spiel als finalized speichern
  const gaeste = [];
  document.querySelectorAll('#tab_Gaeste tbody tr').forEach(row => {
    const name = row.querySelector('input[type="text"]').value.trim();
    if (name) {
      gaeste.push({
        name: name,
        getraenke: row.getAttribute('data-getraenke'),
        essen: row.getAttribute('data-essen'),
        paid: row.getAttribute('data-paid') === 'true',
        tip: row.getAttribute('data-tip') || '0.00'
      });
    }
  });

  const spielData = { 
    team, 
    opponent, 
    date, 
    gaeste, 
    status: 'finalized',
    finalizedAt: new Date().toISOString()
  };

  // PDF erstellen
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const tableData = [];
  const drinksSummary = {};
  const foodSummary = {};
  let totalAmount = 0;
  let totalTip = 0;

  gaeste.forEach(gast => {
    const getraenke = JSON.parse(gast.getraenke || '{}');
    const essen = JSON.parse(gast.essen || '{}');
    
    // Berechne Betrag f√ºr diesen Gast
    let gastBetrag = 0;
    
    // Getr√§nke berechnen
    for (let [name, menge] of Object.entries(getraenke)) {
      const getraenk = getraenkeListe.find(g => g.name === name);
      if (getraenk) {
        gastBetrag += getraenk.preis * menge;
      }
    }
    
    // Essen berechnen
    for (let [name, menge] of Object.entries(essen)) {
      const essenItem = essenListe.find(e => e.name === name);
      if (essenItem) {
        gastBetrag += essenItem.preis * menge;
      }
    }

    const tip = parseFloat(gast.tip || '0');
    totalAmount += gastBetrag;
    totalTip += tip;

    // Getr√§nke Text + Summen berechnen
    let getraenkeText = '';
    for (let [k, v] of Object.entries(getraenke)) {
      if (v > 0) {
        getraenkeText += `${k} (${v}) `;
        drinksSummary[k] = (drinksSummary[k] || 0) + v;
      }
    }

    // Essen Text + Summen berechnen
    let essenText = '';
    for (let [k, v] of Object.entries(essen)) {
      if (v > 0) {
        essenText += `${k} (${v}) `;
        foodSummary[k] = (foodSummary[k] || 0) + v;
      }
    }

    tableData.push([
      gast.name, 
      getraenkeText.trim() || '-', 
      essenText.trim() || '-', 
      gastBetrag.toFixed(2) + ' ‚Ç¨', 
      tip.toFixed(2) + ' ‚Ç¨'
    ]);
  });

  // Summenzeile
  const getraenkeSumme = Object.entries(drinksSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';
  const essenSumme = Object.entries(foodSummary).map(([k, v]) => `${k} (${v})`).join(', ') || '-';

  tableData.push([
    'SUMME', 
    getraenkeSumme, 
    essenSumme, 
    totalAmount.toFixed(2) + ' ‚Ç¨', 
    totalTip.toFixed(2) + ' ‚Ç¨'
  ]);

  // PDF erstellen
  doc.setFontSize(16);
  doc.text(`Abrechnung: ${team} vs ${opponent}`, 10, 15);
  doc.setFontSize(12);
  doc.text(`Datum: ${formatDate(date)}`, 10, 25);

  doc.autoTable({
    head: [['Name', 'Getr√§nke', 'Essen', 'Zwischensumme', 'Trinkgeld']],
    body: tableData,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    startY: 35,
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  // Gesamtsumme am Ende
  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(12);
  doc.text(`Gesamtumsatz: ${(totalAmount + totalTip).toFixed(2)} ‚Ç¨`, 10, finalY);

  // PDF als Base64 String f√ºr Firebase speichern
  const pdfData = doc.output('datauristring');

  // Spiel als finalized speichern/updaten
  let gameId;
  if (editIndex !== null) {
    const existingGame = gespeicherteSpiele[editIndex];
    spielData.firebaseId = existingGame.firebaseId;
    gespeicherteSpiele[editIndex] = spielData;
    gameId = spielData.firebaseId;
    
    if (gameId) {
      await updateGameInFirebase(gameId, spielData);
    }
    editIndex = null;
  } else {
    gameId = await saveGameToFirebase(spielData);
    if (gameId) {
      spielData.firebaseId = gameId;
    }
    gespeicherteSpiele.push(spielData);
  }

  // PDF in Firebase speichern
  if (gameId) {
    await savePDFToFirebase(gameId, pdfData);
    // Lokale Daten auch aktualisieren
    const localGame = gespeicherteSpiele.find(g => g.firebaseId === gameId);
    if (localGame) {
      localGame.pdfData = pdfData;
      localGame.pdfCreatedAt = new Date().toISOString();
    }
  }

  // PDF im Browser √∂ffnen
  const newWindow = window.open();
  newWindow.document.write(`<iframe src="${pdfData}" width="100%" height="100%"></iframe>`);

  // UI aktualisieren und Modal schlie√üen
  renderGames();
  document.getElementById('modalGame').classList.add('hidden');
  clearGameForm();
  
  alert('Spiel wurde final abgerechnet und PDF wurde erstellt!');
});

// PDF anzeigen Funktion
function showPDF(index) {
  const spiel = gespeicherteSpiele[index];
  if (spiel.pdfData) {
    const newWindow = window.open();
    newWindow.document.write(`<iframe src="${spiel.pdfData}" width="100%" height="100%"></iframe>`);
  } else {
    alert('F√ºr dieses Spiel ist kein PDF verf√ºgbar.');
  }
}

function renderGames() {
  const container = document.getElementById('gamesContainer');
  container.innerHTML = '';

  if (gespeicherteSpiele.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center">Noch keine Spiele gespeichert.</p>';
    return;
  }

  // Sortierung: zuerst nach Spieldatum, dann nach timestamp/lastUpdated
  gespeicherteSpiele.sort((a, b) => {
    // Spieldatum vergleichen
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    if (dateA.getTime() !== dateB.getTime()) {
      return dateB - dateA; // neuestes Datum zuerst
    }

    // Falls Spieldatum gleich ‚Üí nach Anlage-/Updatezeit sortieren
    const tsA = new Date(a.lastUpdated || a.timestamp || 0);
    const tsB = new Date(b.lastUpdated || b.timestamp || 0);
    return tsA - tsB; // neueste √Ñnderung zuerst
  });

  gespeicherteSpiele.forEach((spiel, index) => {
    const div = document.createElement('div');
    div.className = 'bg-white shadow p-4 mb-2 flex justify-between items-center rounded hover:shadow-md transition-shadow';

    // Status bestimmen
    const isFinalized = spiel.status === 'finalized';
    const isReady = spiel.status === 'ready';
    const hasPDF = spiel.pdfData;
    
    let statusIcon, statusText;
    if (isFinalized) {
      statusIcon = '<span class="text-green-600 text-lg font-bold">‚úì</span>';
      statusText = '<span class="text-xs text-green-600 font-medium">ABGERECHNET</span>';
    } else if (isReady) {
      statusIcon = '<span class="text-blue-600 text-lg">‚úì</span>';
      statusText = '<span class="text-xs text-blue-600 font-medium">BEREIT F√úR ABRECHNUNG</span>';
    } else {
      statusIcon = '<span class="text-orange-500 text-lg">‚è≥</span>';
      statusText = '<span class="text-xs text-orange-600 font-medium">ENTWURF</span>';
    }

    div.innerHTML = `
      <div>
        <div class="flex items-center space-x-2">
          <strong>${spiel.team || 'Unbekanntes Team'}</strong> 
          <span class="text-gray-400">vs</span>
          <span>${spiel.opponent || 'Unbekannter Gegner'}</span>
          ${statusIcon}
        </div>
        <div class="flex items-center space-x-3 mt-1">
          <span class="text-sm text-gray-500">${formatDate(spiel.date)}</span>
          <span class="text-sm text-gray-500">(${spiel.gaeste ? spiel.gaeste.length : 0} G√§ste)</span>
          ${statusText}
        </div>
      </div>
      <div class="flex space-x-2">
        ${hasPDF ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="showPDF(${index})" title="PDF anzeigen">üìÑ</button>` : ''}
        ${!isFinalized ? `<button class="text-blue-600 hover:text-blue-800 text-lg" onclick="editGame(${index})" title="Bearbeiten">‚úèÔ∏è</button>` : ''}
        ${!isFinalized ? `<button class="text-red-600 hover:text-red-800 text-lg" onclick="deleteGame(${index})" title="L√∂schen">üóëÔ∏è</button>` : ''}
      </div>
    `;

    container.appendChild(div);
  });
}

function editGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere Bearbeitung von finalisierten Spielen
  if (spiel.status === 'finalized') {
    alert('Dieses Spiel ist bereits final abgerechnet und kann nicht mehr bearbeitet werden.');
    return;
  }
  
  editIndex = index;

  document.getElementById('selectTeam').value = spiel.team || '';
  document.getElementById('inputOpponent').value = spiel.opponent || '';
  document.getElementById('inputDate').value = spiel.date || '';

  // G√§ste laden
  const tbody = document.querySelector('#tab_Gaeste tbody');
  tbody.innerHTML = '';
  
  if (spiel.gaeste && spiel.gaeste.length > 0) {
    spiel.gaeste.forEach(gast => {
      addGuestRow();
      const lastRow = tbody.lastChild;
      lastRow.querySelector('input[type="text"]').value = gast.name || '';
      if (gast.getraenke) lastRow.setAttribute('data-getraenke', gast.getraenke);
      if (gast.essen) lastRow.setAttribute('data-essen', gast.essen);
      if (gast.tip) lastRow.setAttribute('data-tip', gast.tip);
      
      updateGesamtbetrag(lastRow);
      
      if (gast.paid) {
        lastRow.classList.add('bg-green-100');
        lastRow.setAttribute('data-paid', 'true');

        const nameInput = lastRow.querySelector('input[type="text"]');
        if (nameInput) {
          nameInput.setAttribute('disabled', 'true');
          nameInput.classList.add('bg-gray-200');
        }

        const btnGetraenke = lastRow.querySelector('.btnAddGetraenke');
        if (btnGetraenke) {
          btnGetraenke.setAttribute('disabled', 'true');
          btnGetraenke.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnGetraenke.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnEssen = lastRow.querySelector('.btnAddEssen');
        if (btnEssen) {
          btnEssen.setAttribute('disabled', 'true');
          btnEssen.classList.remove('bg-blue-500', 'hover:bg-blue-600');
          btnEssen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const btnAbrechnen = lastRow.querySelector('.btnAbrechnen');
        if (btnAbrechnen) {
          btnAbrechnen.setAttribute('disabled', 'true');
          btnAbrechnen.classList.remove('bg-gray-500', 'hover:bg-gray-600');
          btnAbrechnen.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        const lastTd = lastRow.querySelectorAll('td')[5];
        if (lastTd) {
          lastTd.innerHTML = '<span class="text-green-600 text-xl">‚úì</span>';
        }
      }
    });
  } else {
    // Fallback: mindestens 4 leere Zeilen
    for (let i = 0; i < 4; i++) addGuestRow();
  }

  document.getElementById('modalGame').classList.remove('hidden');
  updateFinalizeButtonState();
}

function deleteGame(index) {
  const spiel = gespeicherteSpiele[index];
  
  // Verhindere L√∂schen von finalisierten Spielen
  if (spiel.status === 'finalized') {
    alert('Finalisierte Spiele k√∂nnen nicht gel√∂scht werden.');
    return;
  }
  
  if (confirm('Sind Sie sicher, dass Sie dieses Spiel l√∂schen m√∂chten?')) {
    // Aus Firebase l√∂schen wenn Firebase-ID vorhanden
    if (spiel.firebaseId) {
      deleteGameFromFirebase(spiel.firebaseId).then(success => {
        if (success) {
          console.log('Spiel erfolgreich aus Firebase gel√∂scht');
        } else {
          console.warn('Fehler beim L√∂schen aus Firebase, aber lokaler Eintrag wird trotzdem entfernt');
        }
      });
    }
    
    // Aus lokaler Liste entfernen
    gespeicherteSpiele.splice(index, 1);
    renderGames();
    
    // Erfolgs-Nachricht
    alert('Spiel wurde gel√∂scht!');
  }
}

// AUSWERTUNGS-FUNKTIONALIT√ÑT
// ==============================

// Erweiterte loadReports Funktion
async function loadReports() {
  console.log('loadReports aufgerufen');
  
  try {
    // Warten bis Firebase bereit ist
    if (!window.firebaseReady || !window.firebaseDB) {
      console.log('Firebase noch nicht bereit, warte...');
      await new Promise(resolve => {
        if (window.firebaseReady) {
          resolve();
        } else {
          window.addEventListener('firebaseReady', resolve, { once: true });
          // Fallback timeout
          setTimeout(resolve, 3000);
        }
      });
    }

    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert nach Wartezeit');
      document.getElementById('noDataMessage').classList.remove('hidden');
      document.getElementById('reportsTable').classList.add('hidden');
      return;
    }

    console.log('Lade Spiele aus Firebase...');
    const snapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );

    const weeklyData = {};
    const allYears = new Set();

    console.log(`${snapshot.size} Spiele gefunden`);

    snapshot.forEach(doc => {
      const data = doc.data();
      console.log('Verarbeite Spiel:', data);
      
      if (!data.date || !data.gaeste || data.gaeste.length === 0) {
        console.log('Spiel √ºbersprungen - keine Daten oder G√§ste');
        return;
      }

      const date = new Date(data.date);
      const year = date.getFullYear();
      allYears.add(year);

      // Kalenderwoche berechnen (ISO 8601 Standard)
      const week = getISOWeek(date);
      const weekKey = `KW ${week}/${year}`;

      if (!weeklyData[weekKey]) {
        weeklyData[weekKey] = {
          week: week,
          year: year,
          spiele: [],
          getraenkeDetails: {},
          essenDetails: {},
          getraenkeUmsatz: 0,
          essenUmsatz: 0,
          trinkgeld: 0,
          sortDate: date
        };
      }

      // Spiel zur Woche hinzuf√ºgen
      weeklyData[weekKey].spiele.push({
        team: data.team || 'Unbekannt',
        opponent: data.opponent || 'Unbekannt',
        date: data.date
      });

      // G√§ste durchgehen und Ums√§tze berechnen
      data.gaeste.forEach(gast => {
        // Getr√§nke verarbeiten
        if (gast.getraenke) {
          try {
            const getraenkeData = JSON.parse(gast.getraenke);
            for (const [name, menge] of Object.entries(getraenkeData)) {
              if (menge > 0) {
                const getraenk = getraenkeListe.find(g => g.name === name);
                if (getraenk) {
                  weeklyData[weekKey].getraenkeDetails[name] = 
                    (weeklyData[weekKey].getraenkeDetails[name] || 0) + menge;
                  weeklyData[weekKey].getraenkeUmsatz += getraenk.preis * menge;
                }
              }
            }
          } catch (e) {
            console.warn('Fehler beim Parsen der Getr√§nke-Daten:', e);
          }
        }

        // Essen verarbeiten
        if (gast.essen) {
          try {
            const essenData = JSON.parse(gast.essen);
            for (const [name, menge] of Object.entries(essenData)) {
              if (menge > 0) {
                const essen = essenListe.find(e => e.name === name);
                if (essen) {
                  weeklyData[weekKey].essenDetails[name] = 
                    (weeklyData[weekKey].essenDetails[name] || 0) + menge;
                  weeklyData[weekKey].essenUmsatz += essen.preis * menge;
                }
              }
            }
          } catch (e) {
            console.warn('Fehler beim Parsen der Essen-Daten:', e);
          }
        }

        // Trinkgeld
        if (gast.tip) {
          weeklyData[weekKey].trinkgeld += parseFloat(gast.tip);
        }
      });
    });

    console.log('W√∂chentliche Daten:', weeklyData);
    
    // Jahre-Filter bef√ºllen
    fillYearFilter(Array.from(allYears).sort((a, b) => b - a));
    
    // Tabelle rendern
    renderReportsTable(weeklyData);

  } catch (error) {
    console.error("Fehler beim Laden der Auswertung: ", error);
    document.getElementById('noDataMessage').classList.remove('hidden');
    document.getElementById('reportsTable').classList.add('hidden');
  }
}

// ISO Kalenderwoche berechnen
function getISOWeek(date) {
  const tempDate = new Date(date.valueOf());
  const dayNum = (date.getDay() + 6) % 7;
  tempDate.setDate(tempDate.getDate() - dayNum + 3);
  const firstThursday = tempDate.valueOf();
  tempDate.setMonth(0, 1);
  if (tempDate.getDay() !== 4) {
    tempDate.setMonth(0, 1 + ((4 - tempDate.getDay()) + 7) % 7);
  }
  return 1 + Math.ceil((firstThursday - tempDate) / 604800000);
}

// Jahre Filter bef√ºllen
function fillYearFilter(years) {
  const select = document.getElementById('filterYear');
  select.innerHTML = '<option value="">Alle Jahre</option>';
  years.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });
}

// Tabelle rendern
function renderReportsTable(weeklyData) {
  const tbody = document.getElementById('auswertungTableBody');
  const noDataMsg = document.getElementById('noDataMessage');
  const selectedYear = document.getElementById('filterYear').value;

  // Filtern nach Jahr wenn ausgew√§hlt
  let filteredData = weeklyData;
  if (selectedYear) {
    filteredData = {};
    for (const [key, data] of Object.entries(weeklyData)) {
      if (data.year == selectedYear) {
        filteredData[key] = data;
      }
    }
  }

  tbody.innerHTML = '';

  if (Object.keys(filteredData).length === 0) {
    noDataMsg.classList.remove('hidden');
    document.getElementById('reportsTable').classList.add('hidden');
    return;
  }

  noDataMsg.classList.add('hidden');
  document.getElementById('reportsTable').classList.remove('hidden');

  // Nach Datum sortieren (neueste zuerst)
  const sortedEntries = Object.entries(filteredData)
    .sort(([,a], [,b]) => b.sortDate - a.sortDate);

  let totalSpiele = 0;
  let totalGetraenke = 0;
  let totalEssen = 0;
  let totalTrinkgeld = 0;

  sortedEntries.forEach(([weekKey, data]) => {
    const gesamtumsatz = data.getraenkeUmsatz + data.essenUmsatz + data.trinkgeld;
    
    totalSpiele += data.spiele.length;
    totalGetraenke += data.getraenkeUmsatz;
    totalEssen += data.essenUmsatz;
    totalTrinkgeld += data.trinkgeld;

    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    row.innerHTML = `
      <td class="p-3 border text-center font-medium">${weekKey}</td>
      <td class="p-3 border text-center">${data.spiele.length}</td>
      <td class="p-3 border text-right">${data.getraenkeUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.essenUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.trinkgeld.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right font-semibold">${gesamtumsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-center">
        <button class="text-blue-600 hover:text-blue-800 underline" onclick="showWeekDetails('${weekKey}')">
          Details
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // Gesamtsummen aktualisieren
  document.getElementById('totalSpiele').textContent = totalSpiele;
  document.getElementById('totalGetraenke').textContent = `${totalGetraenke.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalEssen').textContent = `${totalEssen.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalTrinkgeld').textContent = `${totalTrinkgeld.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalSumme').textContent = `${(totalGetraenke + totalEssen + totalTrinkgeld).toFixed(2)} ‚Ç¨`;

  // Daten global speichern f√ºr Details-Modal
  window.reportData = weeklyData;
}

// Wochendetails anzeigen
function showWeekDetails(weekKey) {
  const data = window.reportData[weekKey];
  if (!data) return;

  document.getElementById('detailWeekTitle').textContent = weekKey;

  // Spiele
  const spieleHtml = data.spiele.map(spiel => 
    `<div class="mb-2">
      <strong>${spiel.team}</strong> vs <strong>${spiel.opponent}</strong> 
      <span class="text-gray-500 text-sm">(${formatDate(spiel.date)})</span>
    </div>`
  ).join('');
  document.getElementById('detailSpiele').innerHTML = spieleHtml || '<p class="text-gray-500">Keine Spiele</p>';

  // Getr√§nke
  const getraenkeHtml = Object.entries(data.getraenkeDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailGetraenke').innerHTML = getraenkeHtml || '<p class="text-gray-500">Keine Getr√§nke verkauft</p>';

  // Essen
  const essenHtml = Object.entries(data.essenDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailEssen').innerHTML = essenHtml || '<p class="text-gray-500">Kein Essen verkauft</p>';

  document.getElementById('modalWochendetails').classList.remove('hidden');
}

// Event Listeners f√ºr Auswertungen
document.getElementById('filterYear').addEventListener('change', () => {
  if (window.reportData) {
    renderReportsTable(window.reportData);
  }
});

document.getElementById('btnCloseDetails').addEventListener('click', () => {
  document.getElementById('modalWochendetails').classList.add('hidden');
});

// PDF Export
document.getElementById('btnExportPDF').addEventListener('click', () => {
  if (!window.reportData) {
    alert('Keine Daten zum Exportieren verf√ºgbar.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const selectedYear = document.getElementById('filterYear').value;
  const title = selectedYear ? `Auswertung ${selectedYear}` : 'Auswertung (Alle Jahre)';
  
  // Tabellendaten sammeln
  const tableData = [];
  const tbody = document.getElementById('auswertungTableBody');
  
  tbody.querySelectorAll('tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 6) {
      tableData.push([
        cells[0].textContent, // KW
        cells[1].textContent, // Spiele
        cells[2].textContent, // Getr√§nke
        cells[3].textContent, // Essen
        cells[4].textContent, // Trinkgeld
        cells[5].textContent  // Summe
      ]);
    }
  });

  // Gesamtsummen hinzuf√ºgen
  tableData.push([
    'GESAMT',
    document.getElementById('totalSpiele').textContent,
    document.getElementById('totalGetraenke').textContent,
    document.getElementById('totalEssen').textContent,
    document.getElementById('totalTrinkgeld').textContent,
    document.getElementById('totalSumme').textContent
  ]);

  doc.setFontSize(16);
  doc.text(title, 10, 15);
  doc.setFontSize(10);
  doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 10, 25);

  doc.autoTable({
    head: [['Kalenderwoche', 'Spiele', 'Getr√§nke', 'Essen', 'Trinkgeld', 'Summe']],
    body: tableData,
    startY: 35,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  const filename = selectedYear ? `auswertung-${selectedYear}.pdf` : 'auswertung-alle-jahre.pdf';
  doc.save(filename);
});

// Modal schlie√üen bei Escape oder Hintergrund-Klick
document.getElementById('modalWochendetails').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modalWochendetails')) {
    document.getElementById('modalWochendetails').classList.add('hidden');
  }
});

// Globale Funktionen
window.showWeekDetails = showWeekDetails;
window.loadReports = loadReports;

// ==============================
// NAVIGATION UND INITIALISIERUNG
// ==============================

function showPage(page) {
  console.log('Zeige Seite:', page);
  
  // Alle Seiten verstecken
  document.getElementById('page-home').classList.add('hidden');
  document.getElementById('page-reports').classList.add('hidden');
  
  // Aktuelle Seite anzeigen
  document.getElementById('page-' + page).classList.remove('hidden');
  
  // Alle Buttons auf inaktiv setzen (hellgrau)
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('bg-gray-400', 'text-white');
    btn.classList.add('bg-gray-300', 'text-white', 'rounded', 'px-5', 'py-3.5');
  });
  
  // Nur den aktiven Button hervorheben (dunkelgrau)
  const activeBtn = document.getElementById('btn-' + page);
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-300', 'text-white');
    activeBtn.classList.add('bg-gray-400', 'text-white');
  }
  
  // Berichte laden, wenn reports aktiv ist
  if (page === 'reports') {
    console.log('Wechsle zu Reports-Seite, lade Daten...');
    // Kurz warten dann loadReports aufrufen
    setTimeout(() => {
      loadReports();
    }, 100);
  }
}

// Beim Laden der Seite Firebase-Daten laden
window.addEventListener('load', () => {
  console.log('Seite geladen');
  
  // Standardseite festlegen (Startseite)
  showPage('home');
  
  // Firebase-ready Event listener
  window.addEventListener('firebaseReady', () => {
    console.log('Firebase ist bereit, lade Spiele...');
    loadGamesFromFirebase();
  });
  
  // Fallback: Versuche nach 2 Sekunden zu laden
  setTimeout(() => {
    if (window.firebaseReady) {
      loadGamesFromFirebase();
    }
  }, 2000);
});

// Eingabe-Validierung f√ºr Zahlenfelder
document.addEventListener('input', (e) => {
  if (e.target.type === 'number') {
    const value = parseFloat(e.target.value);
    if (isNaN(value) || value < 0) {
      e.target.value = 0;
    }
  }
});

// Keyboard-Shortcuts
document.addEventListener('keydown', (e) => {
  // ESC zum Schlie√üen von Modals
  if (e.key === 'Escape') {
    document.querySelectorAll('.fixed').forEach(modal => {
      if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    });
    
    // Reset aktuelle Variablen
    aktuelleGetraenkeRow = null;
    aktuelleEssenRow = null;
    aktuelleAbrechnungRow = null;
  }
});

// Modal-Hintergrund-Klicks zum Schlie√üen
document.querySelectorAll('.fixed').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      aktuelleGetraenkeRow = null;
      aktuelleEssenRow = null;
      aktuelleAbrechnungRow = null;
    }
  });
});

</script>



</div>

<!-- Seite 2: Auswertungen -->

<!-- Ersetzen Sie den Inhalt des div-Containers "page-reports" mit folgendem Code: -->

<div id="page-reports" class="hidden">
  <h1 class="text-3xl font-bold mb-6">Auswertungen</h1>
  
  <!-- Filter-Bereich -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="flex items-center space-x-4">
      <div>
        <label class="block text-sm font-medium mb-1">Jahr filtern</label>
        <select id="filterYear" class="border rounded p-2">
          <option value="">Alle Jahre</option>
        </select>
      </div>
      <div>
        <button id="btnExportPDF" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Als PDF exportieren</button>
      </div>
    </div>
  </div>

  <!-- Auswertungstabelle -->
  <div class="bg-white shadow rounded overflow-hidden">
    <table id="reportsTable" class="min-w-full border">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-3 border font-semibold">Kalenderwoche</th>
          <th class="p-3 border font-semibold">Spiele</th>
          <th class="p-3 border font-semibold">Getr√§nke (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Essen (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Trinkgeld (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Summe (‚Ç¨)</th>
          <th class="p-3 border font-semibold">Details</th>
        </tr>
      </thead>
      <tbody id="auswertungTableBody">
        <!-- Wird dynamisch bef√ºllt -->
      </tbody>
      <tfoot class="bg-gray-100">
        <tr class="font-bold">
          <td class="p-3 border">GESAMT</td>
          <td class="p-3 border text-center" id="totalSpiele">0</td>
          <td class="p-3 border text-right" id="totalGetraenke">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalEssen">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalTrinkgeld">0.00 ‚Ç¨</td>
          <td class="p-3 border text-right" id="totalSumme">0.00 ‚Ç¨</td>
          <td class="p-3 border"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Leer-Zustand -->
  <div id="noDataMessage" class="text-center py-8 text-gray-500 hidden">
    <p>Keine Daten f√ºr die Auswertung verf√ºgbar.</p>
  </div>
</div>

<!-- Modal: Wochendetails -->
<div id="modalWochendetails" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-4">Details f√ºr <span id="detailWeekTitle"></span></h2>
    
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Spiele in dieser Woche:</h3>
      <div id="detailSpiele" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkaufte Getr√§nke:</h3>
      <div id="detailGetraenke" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Verkauftes Essen:</h3>
      <div id="detailEssen" class="bg-gray-50 p-3 rounded">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>

    <div class="flex justify-end">
      <button id="btnCloseDetails" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Schlie√üen</button>
    </div>
  </div>
</div>

<script>
// Erweiterte loadReports Funktion
async function loadReports() {
  try {
    if (!window.firebaseDB) {
      console.warn('Firebase nicht initialisiert');
      return;
    }

    const snapshot = await window.firebaseUtils.getDocs(
      window.firebaseUtils.collection(window.firebaseDB, "spiele")
    );

    const weeklyData = {};
    const allYears = new Set();

    // Getr√§nke und Essen Listen (aus dem urspr√ºnglichen Code √ºbernehmen)
    const getraenkeListe = [
      { name: 'Softdrink/Wasser', preis: 2.50 },
      { name: 'Bier des Monats', preis: 3.50 },
      { name: 'Krausenbier', preis: 3.00 },
      { name: 'Weizen', preis: 3.50 },
      { name: 'Winzerschorle', preis: 4.50 },
      { name: 'Kaffee/Tee', preis: 1.50 },
      { name: 'Cola', preis: 2.50 }
    ];

    const essenListe = [
      { name: 'Pizza', preis: 9.00 },
      { name: 'Chicken Nuggets', preis: 5.00 },
      { name: 'Chilli Cheese Nuggets', preis: 5.00 },
      { name: 'Riegel', preis: 1.00 }
    ];

    snapshot.forEach(doc => {
      const data = doc.data();
      if (!data.date || !data.gaeste) return;

      const date = new Date(data.date);
      const year = date.getFullYear();
      allYears.add(year);

      // Kalenderwoche berechnen (ISO 8601 Standard)
      const week = getISOWeek(date);
      const weekKey = `KW ${week}/${year}`;

      if (!weeklyData[weekKey]) {
        weeklyData[weekKey] = {
          week: week,
          year: year,
          spiele: [],
          getraenkeDetails: {},
          essenDetails: {},
          getraenkeUmsatz: 0,
          essenUmsatz: 0,
          trinkgeld: 0,
          sortDate: date
        };
      }

      // Spiel zur Woche hinzuf√ºgen
      weeklyData[weekKey].spiele.push({
        team: data.team || 'Unbekannt',
        opponent: data.opponent || 'Unbekannt',
        date: data.date
      });

      // G√§ste durchgehen und Ums√§tze berechnen
      data.gaeste.forEach(gast => {
        // Getr√§nke verarbeiten
        if (gast.getraenke) {
          const getraenkeData = JSON.parse(gast.getraenke);
          for (const [name, menge] of Object.entries(getraenkeData)) {
            if (menge > 0) {
              const getraenk = getraenkeListe.find(g => g.name === name);
              if (getraenk) {
                weeklyData[weekKey].getraenkeDetails[name] = 
                  (weeklyData[weekKey].getraenkeDetails[name] || 0) + menge;
                weeklyData[weekKey].getraenkeUmsatz += getraenk.preis * menge;
              }
            }
          }
        }

        // Essen verarbeiten
        if (gast.essen) {
          const essenData = JSON.parse(gast.essen);
          for (const [name, menge] of Object.entries(essenData)) {
            if (menge > 0) {
              const essen = essenListe.find(e => e.name === name);
              if (essen) {
                weeklyData[weekKey].essenDetails[name] = 
                  (weeklyData[weekKey].essenDetails[name] || 0) + menge;
                weeklyData[weekKey].essenUmsatz += essen.preis * menge;
              }
            }
          }
        }

        // Trinkgeld
        if (gast.tip) {
          weeklyData[weekKey].trinkgeld += parseFloat(gast.tip);
        }
      });
    });

    // Jahre-Filter bef√ºllen
    fillYearFilter(Array.from(allYears).sort((a, b) => b - a));
    
    // Tabelle rendern
    renderReportsTable(weeklyData);

  } catch (error) {
    console.error("Fehler beim Laden der Auswertung: ", error);
    document.getElementById('noDataMessage').classList.remove('hidden');
  }
}

// ISO Kalenderwoche berechnen
function getISOWeek(date) {
  const tempDate = new Date(date.valueOf());
  const dayNum = (date.getDay() + 6) % 7;
  tempDate.setDate(tempDate.getDate() - dayNum + 3);
  const firstThursday = tempDate.valueOf();
  tempDate.setMonth(0, 1);
  if (tempDate.getDay() !== 4) {
    tempDate.setMonth(0, 1 + ((4 - tempDate.getDay()) + 7) % 7);
  }
  return 1 + Math.ceil((firstThursday - tempDate) / 604800000);
}

// Jahre Filter bef√ºllen
function fillYearFilter(years) {
  const select = document.getElementById('filterYear');
  select.innerHTML = '<option value="">Alle Jahre</option>';
  years.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });
}

// Tabelle rendern
function renderReportsTable(weeklyData) {
  const tbody = document.getElementById('auswertungTableBody');
  const noDataMsg = document.getElementById('noDataMessage');
  const selectedYear = document.getElementById('filterYear').value;

  // Filtern nach Jahr wenn ausgew√§hlt
  let filteredData = weeklyData;
  if (selectedYear) {
    filteredData = {};
    for (const [key, data] of Object.entries(weeklyData)) {
      if (data.year == selectedYear) {
        filteredData[key] = data;
      }
    }
  }

  tbody.innerHTML = '';

  if (Object.keys(filteredData).length === 0) {
    noDataMsg.classList.remove('hidden');
    document.getElementById('reportsTable').classList.add('hidden');
    return;
  }

  noDataMsg.classList.add('hidden');
  document.getElementById('reportsTable').classList.remove('hidden');

  // Nach Datum sortieren (neueste zuerst)
  const sortedEntries = Object.entries(filteredData)
    .sort(([,a], [,b]) => b.sortDate - a.sortDate);

  let totalSpiele = 0;
  let totalGetraenke = 0;
  let totalEssen = 0;
  let totalTrinkgeld = 0;

  sortedEntries.forEach(([weekKey, data]) => {
    const gesamtumsatz = data.getraenkeUmsatz + data.essenUmsatz + data.trinkgeld;
    
    totalSpiele += data.spiele.length;
    totalGetraenke += data.getraenkeUmsatz;
    totalEssen += data.essenUmsatz;
    totalTrinkgeld += data.trinkgeld;

    // Spiele-String f√ºr Anzeige
    const spieleText = data.spiele.map(spiel => 
      `${spiel.team} vs ${spiel.opponent}`
    ).join(', ');

    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    row.innerHTML = `
      <td class="p-3 border text-center font-medium">${weekKey}</td>
      <td class="p-3 border text-center">${data.spiele.length}</td>
      <td class="p-3 border text-right">${data.getraenkeUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.essenUmsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right">${data.trinkgeld.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-right font-semibold">${gesamtumsatz.toFixed(2)} ‚Ç¨</td>
      <td class="p-3 border text-center">
        <button class="text-blue-600 hover:text-blue-800 underline" onclick="showWeekDetails('${weekKey}')">
          Details
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // Gesamtsummen aktualisieren
  document.getElementById('totalSpiele').textContent = totalSpiele;
  document.getElementById('totalGetraenke').textContent = `${totalGetraenke.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalEssen').textContent = `${totalEssen.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalTrinkgeld').textContent = `${totalTrinkgeld.toFixed(2)} ‚Ç¨`;
  document.getElementById('totalSumme').textContent = `${(totalGetraenke + totalEssen + totalTrinkgeld).toFixed(2)} ‚Ç¨`;

  // Daten global speichern f√ºr Details-Modal
  window.reportData = weeklyData;
}

// Wochendetails anzeigen
function showWeekDetails(weekKey) {
  const data = window.reportData[weekKey];
  if (!data) return;

  document.getElementById('detailWeekTitle').textContent = weekKey;

  // Spiele
  const spieleHtml = data.spiele.map(spiel => 
    `<div class="mb-2">
      <strong>${spiel.team}</strong> vs <strong>${spiel.opponent}</strong> 
      <span class="text-gray-500 text-sm">(${formatDate(spiel.date)})</span>
    </div>`
  ).join('');
  document.getElementById('detailSpiele').innerHTML = spieleHtml || '<p class="text-gray-500">Keine Spiele</p>';

  // Getr√§nke
  const getraenkeHtml = Object.entries(data.getraenkeDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailGetraenke').innerHTML = getraenkeHtml || '<p class="text-gray-500">Keine Getr√§nke verkauft</p>';

  // Essen
  const essenHtml = Object.entries(data.essenDetails)
    .map(([name, menge]) => `<div>${name}: ${menge} St√ºck</div>`)
    .join('');
  document.getElementById('detailEssen').innerHTML = essenHtml || '<p class="text-gray-500">Kein Essen verkauft</p>';

  document.getElementById('modalWochendetails').classList.remove('hidden');
}

// Event Listeners
document.getElementById('filterYear').addEventListener('change', () => {
  if (window.reportData) {
    renderReportsTable(window.reportData);
  }
});

document.getElementById('btnCloseDetails').addEventListener('click', () => {
  document.getElementById('modalWochendetails').classList.add('hidden');
});

// PDF Export
document.getElementById('btnExportPDF').addEventListener('click', () => {
  if (!window.reportData) {
    alert('Keine Daten zum Exportieren verf√ºgbar.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const selectedYear = document.getElementById('filterYear').value;
  const title = selectedYear ? `Auswertung ${selectedYear}` : 'Auswertung (Alle Jahre)';
  
  // Tabellendaten sammeln
  const tableData = [];
  const tbody = document.getElementById('auswertungTableBody');
  
  tbody.querySelectorAll('tr').forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 6) {
      tableData.push([
        cells[0].textContent, // KW
        cells[1].textContent, // Spiele
        cells[2].textContent, // Getr√§nke
        cells[3].textContent, // Essen
        cells[4].textContent, // Trinkgeld
        cells[5].textContent  // Summe
      ]);
    }
  });

  // Gesamtsummen hinzuf√ºgen
  tableData.push([
    'GESAMT',
    document.getElementById('totalSpiele').textContent,
    document.getElementById('totalGetraenke').textContent,
    document.getElementById('totalEssen').textContent,
    document.getElementById('totalTrinkgeld').textContent,
    document.getElementById('totalSumme').textContent
  ]);

  doc.setFontSize(16);
  doc.text(title, 10, 15);
  doc.setFontSize(10);
  doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')}`, 10, 25);

  doc.autoTable({
    head: [['Kalenderwoche', 'Spiele', 'Getr√§nke', 'Essen', 'Trinkgeld', 'Summe']],
    body: tableData,
    startY: 35,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [70, 130, 180], textColor: 255 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didParseCell: function (data) {
      if (data.row.index === tableData.length - 1) {
        data.cell.styles.fontStyle = 'bold';
        data.cell.styles.fillColor = [220, 220, 220];
      }
    }
  });

  const filename = selectedYear ? `auswertung-${selectedYear}.pdf` : 'auswertung-alle-jahre.pdf';
  doc.save(filename);
});

// Modal schlie√üen bei Escape oder Hintergrund-Klick
document.getElementById('modalWochendetails').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modalWochendetails')) {
    document.getElementById('modalWochendetails').classList.add('hidden');
  }
});

// Hilfsfunktion f√ºr Datumsformatierung (falls nicht bereits vorhanden)
function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split("-");
  return `${day}.${month}.${year}`;
}

// Globale Funktion f√ºr Navigation (falls nicht bereits vorhanden)
window.showWeekDetails = showWeekDetails;

// Sicherstellen, dass loadReports beim Seitenwechsel aufgerufen wird
window.loadReports = loadReports;
</script>

<script>
function showPage(page) {
  // Alle Seiten verstecken
  document.getElementById('page-home').classList.add('hidden');
  document.getElementById('page-reports').classList.add('hidden');
  
  // Aktuelle Seite anzeigen
  document.getElementById('page-' + page).classList.remove('hidden');
  
  // Alle Buttons auf inaktiv setzen (hellgrau)
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('bg-gray-400', 'text-white');
    btn.classList.add('bg-gray-300', 'text-white', 'rounded', 'px-5', 'py-3.5');
  });
  
  // Nur den aktiven Button hervorheben (dunkelgrau)
  const activeBtn = document.getElementById('btn-' + page);
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-300', 'text-white');
    activeBtn.classList.add('bg-gray-400', 'text-white');
  }
  
  // Berichte laden, wenn reports aktiv ist
  if (page === 'reports') {
    console.log('Wechsle zu Reports-Seite, lade Daten...');
    if (window.loadReports) {
      window.loadReports();
    } else {
      console.log('loadReports Funktion nicht verf√ºgbar, versuche in 1 Sekunde erneut...');
      setTimeout(() => {
        if (window.loadReports) {
          window.loadReports();
        } else {
          console.error('loadReports Funktion immer noch nicht verf√ºgbar!');
        }
      }, 1000);
    }
  }
}
  
// Standardseite festlegen (Startseite)
document.addEventListener("DOMContentLoaded", () => {
  showPage('home');
});
</script>

</body>
</html>